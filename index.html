<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ice Cream Lab â€” ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ãƒ©ãƒœ</title>
<meta name="theme-color" content="#FF5722">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ice Cream Lab">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{colors:{traditional:'#E5960B',keto:'#00A89D',sorbet:'#FF6B6B',experimental:'#8B5CF6',accent:'#FF5722',surface:'#FAFAF7'}}}}
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
*{font-family:'Inter',system-ui,sans-serif;-webkit-tap-highlight-color:transparent}
body{background:#FAFAF7;margin:0;padding:0;overscroll-behavior:none}
input,textarea,select{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes timerPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.fade-in{animation:fadeIn .3s ease-out}.slide-up{animation:slideUp .3s ease-out}
.timer-pulse{animation:timerPulse 1s ease-in-out infinite}
.cook-mode{background:#111827;color:#F9FAFB;min-height:100vh;min-height:100dvh}
.heat-cell{width:13px;height:13px;border-radius:2px}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback,useMemo,createContext,useContext}=React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CATEGORIES=['traditional','keto','sorbet','experimental'];
const CAT_COLORS={traditional:'#E5960B',keto:'#00A89D',sorbet:'#FF6B6B',experimental:'#8B5CF6'};
const CAT_EMOJI={traditional:'ğŸ¦',keto:'ğŸ¥‘',sorbet:'ğŸ“',experimental:'ğŸ§ª'};
const UNITS=['g','ml','tsp','tbsp','pieces','drops','pinch'];
const ING_CATS=['dairy','sweetener','egg','flavor','stabilizer','emulsifier','other'];
const RATING_LABELS={
  texture:['Icy','Slightly icy','Decent','Smooth','Perfectly creamy'],
  sweetness:['Not sweet','Under-sweet','Just right','Bit sweet','Too sweet'],
  scoopability:['Rock hard','Very firm','Firm','Scoopable','Too soft'],
  flavor:['Off/bland','Weak','Good','Great','Excellent'],
  overall:['Poor','Below avg','Average','Good','Excellent']
};
const uid=()=>crypto.randomUUID();
const fmt=(d)=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});

// â”€â”€ Preferences constants â”€â”€
const VANILLA_OPTIONS=[
  {key:'bean',label:'Vanilla Bean',desc:'Split & scraped into dairy before heating'},
  {key:'paste',label:'Vanilla Paste',desc:'Stirred into dairy before heating'},
  {key:'extract',label:'Vanilla Extract',desc:'Added after cooking (heat destroys flavor)'},
];
const TEXTURE_AGENTS=[
  {key:'none',label:'None',desc:'Pure baseline, no stabilizer'},
  {key:'commercial_stabilizer',label:'Commercial stabilizer',desc:'Best texture (mixed with sugar before heating)'},
  {key:'guar_gum',label:'Guar gum',desc:'Least icy (blended into chilled custard)'},
  {key:'xanthan_gum',label:'Xanthan gum',desc:'Least icy (blended into chilled custard)'},
  {key:'tapioca_starch',label:'Tapioca starch',desc:'Easiest to use (whisked in after cooking)'},
  {key:'cornstarch',label:'Cornstarch',desc:'Most accessible (added before eggs, cook 1 min)'},
];
const VANILLA_LABELS={bean:'Bean',paste:'Paste',extract:'Extract'};
const AGENT_LABELS={none:'None',commercial_stabilizer:'Stabilizer',guar_gum:'Guar',xanthan_gum:'Xanthan',tapioca_starch:'Tapioca',cornstarch:'Cornstarch'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DYNAMIC BASELINE RECIPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASELINE_ID='starter-vanilla-custard-001';
// Shared custard base (dairy, egg, salt) â€” same across all variants
const CUSTARD_BASE=[
  {id:'vc01',name:'Heavy cream 35%',nameJa:'ç´”ç”Ÿã‚¯ãƒªãƒ¼ãƒ  35%',amount:90,unit:'g',category:'dairy'},
  {id:'vc02',name:'Whole milk',nameJa:'ç‰›ä¹³',amount:120,unit:'g',category:'dairy'},
  {id:'vc05',name:'Egg yolks',nameJa:'åµé»„',amount:30,unit:'g',category:'egg',isYolk:true},
  {id:'vc06',name:'Salt',nameJa:'å¡©',amount:1,unit:'pinch',category:'other'},
];
const YOLK_REF_G=30; // reference yolk weight at 300ml scale
const VANILLA_INGREDIENTS={
  bean:{id:'vi-bean',name:'Vanilla bean',nameJa:'ãƒãƒ‹ãƒ©ã®ã•ã‚„',amount:1,unit:'bean',category:'flavor'},
  paste:{id:'vi-paste',name:'Vanilla bean paste',nameJa:'ãƒãƒ‹ãƒ©ãƒ“ãƒ¼ãƒ³ã‚ºãƒšãƒ¼ã‚¹ãƒˆ',amount:6,unit:'g',category:'flavor'},
  extract:{id:'vi-extract',name:'Vanilla extract',nameJa:'ãƒãƒ‹ãƒ©ã‚¨ã‚¯ã‚¹ãƒˆãƒ©ã‚¯ãƒˆ',amount:6,unit:'g',category:'flavor'},
};
// Temperature conversion helpers
const TEMP_REFS={'82':'180','80':'176','85':'185','10':'50','4':'40'};
function toF(c){return Math.round(c*9/5+32)}
function tempStr(c,unit){return unit==='F'?`${toF(c)}Â°F`:`${c}Â°C`}
function convertTempsInText(text,unit){if(!unit||unit==='C')return text;return text.replace(/(\d+)\s*[-â€“]\s*(\d+)\s*Â°C/g,(m,lo,hi)=>`${toF(+lo)}â€“${toF(+hi)}Â°F`).replace(/(\d+)\s*Â°C/g,(m,n)=>`${toF(+n)}Â°F`)}
const AGENT_INGREDIENTS={
  none:null,
  commercial_stabilizer:{id:'ai-cs',name:'Commercial ice cream stabilizer',nameJa:'ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ å®‰å®šå‰¤',amount:1,unit:'g',category:'stabilizer'},
  guar_gum:{id:'ai-gg',name:'Guar gum',nameJa:'ã‚°ã‚¢ãƒ¼ã‚¬ãƒ ',amount:0.3,unit:'g',category:'stabilizer'},
  xanthan_gum:{id:'ai-xg',name:'Xanthan gum',nameJa:'ã‚­ã‚µãƒ³ã‚¿ãƒ³ã‚¬ãƒ ',amount:0.3,unit:'g',category:'stabilizer'},
  tapioca_starch:{id:'ai-ts',name:'Tapioca starch',nameJa:'ã‚¿ãƒ”ã‚ªã‚«æ¾±ç²‰',amount:1.5,unit:'g',category:'stabilizer',extra:{id:'ai-ts-m',name:'Cold milk (for slurry)',nameJa:'ç‰›ä¹³ï¼ˆã‚¹ãƒ©ãƒªãƒ¼ç”¨ï¼‰',amount:6,unit:'g',category:'dairy'}},
  cornstarch:{id:'ai-cs2',name:'Cornstarch',nameJa:'ã‚³ãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ',amount:3,unit:'g',category:'stabilizer',extra:{id:'ai-cs2-m',name:'Cold milk (for slurry)',nameJa:'ç‰›ä¹³ï¼ˆã‚¹ãƒ©ãƒªãƒ¼ç”¨ï¼‰',amount:6,unit:'g',category:'dairy'}},
};

// â”€â”€ Built-in recipe variant configs â”€â”€
const BUILT_IN_IDS=[BASELINE_ID,'vanilla-keto-001','vanilla-50pct-sugar-001','vanilla-20pct-less-sweet-001','oreo-50pct-sugar-001'];
const BUILT_IN_CONFIGS={
  [BASELINE_ID]:{
    name:'Classic Vanilla Custard (Baseline)',category:'traditional',
    sweeteners:[
      {id:'vc03',name:'Granulated sugar',nameJa:'ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ¼ç³–',amount:45,unit:'g',category:'sweetener'},
      {id:'vc04',name:'Glucose syrup',nameJa:'æ°´é£´',amount:15,unit:'g',category:'sweetener'},
    ],
    sweetHeat:'45g sugar{note}, and 15g glucose syrup',stabLabel:'the 45g sugar',stabId:'vc03',stabName:'sugar',
    stats:{fatPercent:12,sweetenerPercent:20,totalSolidsPercent:40,estimatedCostYen:480},
    tags:['vanilla','custard-base','baseline','first-batch','french-style','dana-cree'],
    source:{type:'book',url:'',bookTitle:'Hello, My Name Is Ice Cream',bookPage:'Vanilla Ice Cream, Custard Base',
      rawText:'Dana Cree\'s vanilla custard base, scaled to 0.30Ã— for 300ml STI ice cream maker. Vanilla type and texture agent are customizable based on your preferences.'},
  },
  'vanilla-keto-001':{
    name:'Vanilla Custard (Keto)',category:'keto',
    sweeteners:[
      {id:'ks01',name:'Allulose',nameJa:'ã‚¢ãƒ«ãƒ­ãƒ¼ã‚¹',amount:40,unit:'g',category:'sweetener'},
    ],
    sweetHeat:'40g allulose{note}',stabLabel:'the 40g allulose',stabId:'ks01',stabName:'allulose',
    stats:{fatPercent:14,sweetenerPercent:13,totalSolidsPercent:35},
    tags:['vanilla','custard-base','keto','sugar-free','allulose'],
    source:{type:'custom',url:'',bookTitle:'',bookPage:'',
      rawText:'Keto adaptation of Dana Cree\'s vanilla custard base. Allulose replaces all sugar and glucose syrup.'},
  },
  'vanilla-50pct-sugar-001':{
    name:'Vanilla Custard (50% Sugar)',category:'experimental',
    sweeteners:[
      {id:'hs01',name:'Granulated sugar',nameJa:'ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ¼ç³–',amount:23,unit:'g',category:'sweetener'},
      {id:'hs02',name:'Glucose syrup',nameJa:'æ°´é£´',amount:8,unit:'g',category:'sweetener'},
      {id:'hs03',name:'Allulose',nameJa:'ã‚¢ãƒ«ãƒ­ãƒ¼ã‚¹',amount:30,unit:'g',category:'sweetener'},
    ],
    sweetHeat:'23g sugar{note}, 8g glucose syrup, and 30g allulose',stabLabel:'the 23g sugar',stabId:'hs01',stabName:'sugar',
    stats:{fatPercent:12,sweetenerPercent:20,totalSolidsPercent:38},
    tags:['vanilla','custard-base','reduced-sugar','allulose','50-percent-sugar'],
    source:{type:'custom',url:'',bookTitle:'',bookPage:'',
      rawText:'Reduced-sugar adaptation of Dana Cree\'s vanilla custard base. Half the sweetener is traditional (sugar + glucose), half is allulose.'},
  },
  'vanilla-20pct-less-sweet-001':{
    name:'Vanilla Custard (20% Less Sweet)',category:'traditional',
    sweeteners:[
      {id:'ls01',name:'Granulated sugar',nameJa:'ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ¼ç³–',amount:36,unit:'g',category:'sweetener'},
      {id:'ls02',name:'Glucose syrup',nameJa:'æ°´é£´',amount:12,unit:'g',category:'sweetener'},
    ],
    sweetHeat:'36g sugar{note}, and 12g glucose syrup',stabLabel:'the 36g sugar',stabId:'ls01',stabName:'sugar',
    stats:{fatPercent:12,sweetenerPercent:16,totalSolidsPercent:37},
    tags:['vanilla','custard-base','less-sweet','reduced-sweetener'],
    source:{type:'custom',url:'',bookTitle:'',bookPage:'',
      rawText:'20% reduced sweetener adaptation of Dana Cree\'s vanilla custard base.'},
  },
  'oreo-50pct-sugar-001':{
    name:'Oreo (50% Sugar)',category:'experimental',
    sweeteners:[
      {id:'or01',name:'Granulated sugar',nameJa:'ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ¼ç³–',amount:18,unit:'g',category:'sweetener'},
      {id:'or02',name:'Glucose syrup',nameJa:'æ°´é£´',amount:6,unit:'g',category:'sweetener'},
      {id:'or03',name:'Allulose',nameJa:'ã‚¢ãƒ«ãƒ­ãƒ¼ã‚¹',amount:18,unit:'g',category:'sweetener'},
    ],
    sweetHeat:'18g sugar{note}, 6g glucose syrup, and 18g allulose',stabLabel:'the 18g sugar',stabId:'or01',stabName:'sugar',
    mixIns:[
      {ingredient:{id:'or-oreo',name:'Crushed Oreos',nameJa:'ã‚ªãƒ¬ã‚ªï¼ˆç •ã„ãŸã‚‚ã®ï¼‰',amount:'40â€“50',unit:'g',category:'other'},
       instruction:'In the last 5 minutes of churning, add 40â€“50g of roughly crushed Oreos. Fold them in so they stay chunky and don\'t fully dissolve into the base.'}
    ],
    stats:{fatPercent:11,sweetenerPercent:14,totalSolidsPercent:40},
    tags:['oreo','cookies-and-cream','50-percent-sugar','allulose','mix-in'],
    source:{type:'custom',url:'',bookTitle:'',bookPage:'',
      rawText:'Oreo cookies & cream custard base with 50% sugar reduction via allulose. Vanilla bean paste added after cooling. Oreos folded in during last 5 minutes of churning.'},
  },
};

function resolveVariantIngredients(config,prefs){
  const ings=[...CUSTARD_BASE,...config.sweeteners];
  if(config.fixedVanilla){ings.push(config.fixedVanilla.ingredient)}
  else{const vi=VANILLA_INGREDIENTS[prefs.vanillaPreference||'paste'];if(vi) ings.push(vi)}
  if(config.mixIns) config.mixIns.forEach(m=>ings.push(m.ingredient));
  const ai=AGENT_INGREDIENTS[prefs.textureAgentPreference||'none'];
  if(ai){ings.push(ai);if(ai.extra)ings.push(ai.extra);}
  return ings;
}

function resolveVariantSteps(config,prefs){
  const hasFixedV=!!config.fixedVanilla;
  const v=hasFixedV?null:(prefs.vanillaPreference||'paste');
  const vanillaTiming=hasFixedV?config.fixedVanilla.timing:(v==='extract'?'post-cook':'heat');
  const t=prefs.textureAgentPreference||'none';
  const vanillaHeatText=vanillaTiming==='heat'?(v==='bean'?'Add your vanilla bean â€” split lengthwise, scrape seeds into the pot, and drop the pod in too.':v==='paste'?'Stir in 6g vanilla bean paste.':''):'';
  const vanillaNote=vanillaTiming!=='heat'?' Do not add vanilla yet â€” it will be added later.':'';
  const sugarNote=t==='commercial_stabilizer'?` The ${config.stabName} already has your stabilizer mixed in.`:'';
  const sweetHeat=config.sweetHeat.replace('{note}',sugarNote);const sweetIngIds=config.sweeteners.map(s=>s.id);
  const vanillaIngId=hasFixedV?config.fixedVanilla.ingredient.id:(VANILLA_INGREDIENTS[v]?.id||null);
  const needsInfusion=vanillaTiming==='heat'&&(v==='bean'||v==='paste');
  const steps=[];
  // 1: Ice bath
  steps.push({id:'bs1',order:1,title:'Prepare ice bath',instruction:'Fill a large bowl two-thirds with ice water. Place a smaller metal or glass bowl inside it. Set a fine-mesh strainer (ã“ã—å™¨) over the inner bowl. Set aside in fridge.',timerSeconds:null,ingredients:[],condition:null});
  // 2: Stabilizer prep (conditional)
  if(t==='commercial_stabilizer') steps.push({id:'bs2a',order:2,title:'Prepare stabilizer',instruction:`Mix 1g commercial stabilizer into ${config.stabLabel}, stirring well so it's evenly distributed. This will be added to the dairy in the next step.`,timerSeconds:null,ingredients:['ai-cs',config.stabId],condition:'commercial_stabilizer'});
  if(t==='tapioca_starch') steps.push({id:'bs2b',order:2,title:'Prepare starch slurry',instruction:'In a small bowl, mix 1.5g tapioca starch with 6g cold milk. Stir until smooth with no lumps. Set aside â€” you\'ll add this after the custard is cooked.',timerSeconds:null,ingredients:['ai-ts','ai-ts-m'],condition:'tapioca_starch'});
  if(t==='cornstarch') steps.push({id:'bs2c',order:2,title:'Prepare starch slurry',instruction:'In a small bowl, mix 3g cornstarch with 6g cold milk. Stir until smooth with no lumps. Set aside â€” you\'ll add this to the hot dairy before the eggs.',timerSeconds:null,ingredients:['ai-cs2','ai-cs2-m'],condition:'cornstarch'});
  // 3: Heat dairy
  steps.push({id:'bs3',order:3,title:'Heat dairy and sweetener',instruction:`Combine 90g heavy cream, 120g milk, ${sweetHeat} in a medium saucepan. ${vanillaHeatText}${vanillaNote} Heat over medium, whisking occasionally, until the mixture comes to a gentle boil with small bubbles around the edges. Remove from heat.`,timerSeconds:300,ingredients:['vc01','vc02',...sweetIngIds,vanillaTiming==='heat'?vanillaIngId:null].filter(Boolean),condition:null});
  // 3b: Infuse vanilla (conditional â€” bean or paste only)
  if(needsInfusion){
    const infuseText=v==='bean'?'Cover the pot and let the vanilla bean steep in the hot dairy for 30 minutes. The longer infusion extracts deeper flavor from the bean. After steeping, remove the pod (you can rinse, dry, and reuse it once more, or make vanilla sugar).':'Cover the pot and let the vanilla paste infuse in the hot dairy for 30 minutes. This resting period lets the flavor develop fully.';
    steps.push({id:'bs3b',order:3,title:'Infuse vanilla (30 min)',instruction:`${infuseText} After infusing, reheat the dairy to a gentle simmer before proceeding.`,timerSeconds:1800,ingredients:[],condition:v});
  }
  // 4: Cornstarch addition (conditional)
  if(t==='cornstarch') steps.push({id:'bs4',order:4,title:'Add cornstarch slurry',instruction:'Whisk the cornstarch slurry into the hot dairy mixture. Return to heat and cook for 1 minute, stirring constantly, until slightly thickened. Remove from heat.',timerSeconds:60,ingredients:['ai-cs2','ai-cs2-m'],condition:'cornstarch'});
  // 5: Whisk yolks
  steps.push({id:'bs5',order:5,title:'Whisk egg yolks',instruction:'In a medium bowl, whisk your egg yolks (weigh them â€” reference is 30g) until smooth.',timerSeconds:null,ingredients:['vc05'],condition:null});
  // 6: Temper
  steps.push({id:'bs6',order:6,title:'Temper the eggs',instruction:'Add about half a cup of the hot dairy mixture to the yolks while whisking constantly. Pour slowly â€” this gradually raises the egg temperature without scrambling them. Then pour the tempered yolks back into the pot of hot dairy while whisking.',timerSeconds:null,ingredients:[],condition:null});
  // 7: Cook custard
  steps.push({id:'bs7',order:7,title:'Cook the custard',instruction:'Place the pot over medium-low heat. Cook, stirring and scraping the bottom constantly with a rubber spatula to avoid curdling. When the custard thickens enough to coat the back of the spatula (a finger drawn across should leave a clean line), or reaches 80â€“85Â°C, immediately remove from heat. Do NOT let it boil.',timerSeconds:480,ingredients:[],condition:null});
  // 8: Tapioca starch (conditional)
  if(t==='tapioca_starch') steps.push({id:'bs8a',order:8,title:'Add tapioca starch',instruction:'Remove the custard from heat. Immediately whisk in the tapioca starch slurry. Stir well until fully incorporated.',timerSeconds:null,ingredients:['ai-ts','ai-ts-m'],condition:'tapioca_starch'});
  // 8 alt: Vanilla extract (conditional)
  if(vanillaTiming==='post-cook') steps.push({id:'bs8b',order:8,title:'Add vanilla extract',instruction:'Stir in 6g vanilla extract now. Extract is added after cooking because heat destroys its delicate flavor compounds.',timerSeconds:null,ingredients:['vi-extract'],condition:'extract'});
  // 9: Strain and cool
  steps.push({id:'bs9',order:9,title:'Strain and cool',instruction:`Immediately pour the custard through the fine-mesh strainer into the bowl sitting in the ice bath. Stir occasionally until custard is cool to the touch (below 10Â°C).`,timerSeconds:600,ingredients:[],condition:null});
  // 9b: Add vanilla after cooling (for recipes that specify post-cool timing)
  if(vanillaTiming==='post-cool'&&config.fixedVanilla){const fv=config.fixedVanilla.ingredient;steps.push({id:'bs9b',order:9,title:`Add ${fv.name.toLowerCase()}`,instruction:`Stir ${fv.amount}${fv.unit} ${fv.name.toLowerCase()} into the cooled custard. Adding it after cooling preserves the delicate flavor.`,timerSeconds:null,ingredients:[fv.id],condition:null})}
  // 10: Gum stabilizer (conditional)
  if(t==='guar_gum'||t==='xanthan_gum'){
    const gumName=t==='guar_gum'?'guar gum':'xanthan gum';
    const gumId=t==='guar_gum'?'ai-gg':'ai-xg';
    steps.push({id:'bs10',order:10,title:`Blend in ${gumName}`,instruction:`Once the custard is chilled in the ice bath, add 0.3g ${gumName}. Use a hand blender or regular blender to whirl the custard for 30 seconds until the gum is fully dispersed. This must be done when cold â€” gums clump in hot liquid.`,timerSeconds:null,ingredients:[gumId],condition:t});
  }
  // 11: Cure
  steps.push({id:'bs11',order:11,title:'Cure overnight',instruction:'Cover the custard with plastic wrap pressed directly onto the surface (to prevent a skin). Refrigerate at 4Â°C for at least 4 hours, preferably overnight (8-12 hours). This \'aging\' step (ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°) lets fat crystallize, proteins hydrate, and flavors deepen. Your ice cream will be noticeably smoother and creamier.',timerSeconds:null,ingredients:[],condition:null});
  // 12: Churn
  if(config.mixIns?.length){const mixInText=config.mixIns.map(m=>m.instruction).join(' ');const mixInIngIds=config.mixIns.map(m=>m.ingredient.id);steps.push({id:'bs12',order:12,title:'Churn & add mix-ins',instruction:`Give the chilled custard a stir. Pour into your ice cream maker (STI 300ml). Churn according to machine instructions until it reaches soft-serve consistency â€” thick, creamy, and holding its shape. Typically 20-30 minutes. ${mixInText}`,timerSeconds:1500,ingredients:mixInIngIds,condition:null})}
  else steps.push({id:'bs12',order:12,title:'Churn',instruction:'Give the chilled custard a stir. Pour into your ice cream maker (STI 300ml). Churn according to machine instructions until it reaches soft-serve consistency â€” thick, creamy, and holding its shape. Typically 20-30 minutes.',timerSeconds:1500,ingredients:[],condition:null});
  // 13: Harden
  steps.push({id:'bs13',order:13,title:'Harden',instruction:'Transfer churned ice cream to an airtight container. Press plastic wrap directly onto the surface to prevent ice crystals. Freeze for at least 3-4 hours until firm. Let sit at room temperature for 5-10 minutes before scooping.',timerSeconds:null,ingredients:[],condition:null});
  return steps.map((s,i)=>({...s,order:i+1}));
}

const BASELINE_NOTES=`This is your BASELINE recipe from Dana Cree's "Hello, My Name Is Ice Cream." Make this first and rate it honestly â€” it's the yardstick for all future experiments.

Formulation: ~12% fat, ~20% sweetener, ~40% total solids. Fat is lower than HÃ¤agen-Dazs style (~16%) â€” this gives a cleaner, less heavy mouthfeel. The glucose syrup (æ°´é£´) is crucial: it reduces ice crystal formation and improves scoopability. Don't skip it.

Texture agents (from Dana Cree):
â€¢ Best texture: Commercial stabilizer (mixed with sugar)
â€¢ Least icy: Guar or xanthan gum (blended in after chilling)
â€¢ Easiest to use: Tapioca starch (whisked in after cooking)
â€¢ Most accessible: Cornstarch (added before eggs, cooked 1 min)

Recommendation: Try your first batch with NO texture agent to establish a true baseline, then add one on batch 2 to see the difference.

For your KETO version later: Swap the 45g sugar + 15g glucose for ~35-40g allulose. Allulose provides similar freezing point depression. You'll likely want a texture agent too since you're removing sugar solids.`;

const KETO_NOTES=`Keto-friendly version of the baseline vanilla custard. Uses 40g allulose as the sole sweetener, replacing all sugar and glucose syrup.

Allulose provides ~70% of the sweetness of sugar but has nearly zero glycemic impact. It also depresses the freezing point similarly to sugar, keeping ice cream scoopable. However, you lose the browning and body that sugar solids provide â€” a texture agent is strongly recommended.

Tips:
â€¢ Allulose can crystallize if the ice cream sits too long. Eat within 1-2 weeks for best texture.
â€¢ Allulose may cause digestive discomfort in large quantities â€” start with small servings.
â€¢ If the result isn't sweet enough, try adding 2-4g more allulose.`;

const HALF_SUGAR_NOTES=`Reduced-sugar version that replaces half the sweetener with allulose. This gives you most of the traditional custard flavor and texture while cutting actual sugar by ~50%.

Formulation: 23g sugar + 8g glucose + 30g allulose (~61g total sweetener). The sugar and glucose provide familiar caramel notes and body; the allulose fills in sweetness and freezing point depression without the glycemic load.

A good middle ground if full keto is too extreme but you want to reduce sugar intake.`;

const LESS_SWEET_NOTES=`A subtly less sweet version of the baseline â€” all sweeteners reduced by 20%. Good for those who find the baseline too sweet, or who want the vanilla and dairy flavors to come through more prominently.

Formulation: 36g sugar + 12g glucose (down from 45g + 15g). The lower sweetener level will also slightly firm up the ice cream, so consider adding a texture agent if scoopability is important to you.`;

const OREO_NOTES=`Cookies & cream custard base with 50% sugar reduction via allulose. Sweetener split: 18g sugar + 6g glucose + 18g allulose. The lower sweetener total (vs baseline) accounts for the sugar in the Oreos themselves.

Oreos are folded in during the last 5 minutes of churning so they stay chunky. Crush them roughly â€” you want a mix of small bits and larger pieces. About 4-5 Oreos (40-50g) is the right amount for 300ml.

Tips:
â€¢ Don't crush too fine â€” powdered Oreos turn the base gray. Chunky is better.
â€¢ If you want more intense Oreo flavor, scrape out the cream filling and stir it into the custard before churning, then fold in just the cookie pieces.
â€¢ The Oreo pieces soften in the ice cream over time â€” best eaten within a week.`;

const VARIANT_NOTES={[BASELINE_ID]:BASELINE_NOTES,'vanilla-keto-001':KETO_NOTES,'vanilla-50pct-sugar-001':HALF_SUGAR_NOTES,'vanilla-20pct-less-sweet-001':LESS_SWEET_NOTES,'oreo-50pct-sugar-001':OREO_NOTES};

function buildBuiltInRecipe(id,prefs){
  const config=BUILT_IN_CONFIGS[id];
  if(!config) return null;
  return {
    id,name:config.name,category:config.category,
    source:config.source,
    servings:300,
    ingredients:resolveVariantIngredients(config,prefs),
    calculatedStats:config.stats,
    steps:resolveVariantSteps(config,prefs),
    notes:VARIANT_NOTES[id]||'',
    tags:config.tags,
    isBaseline:true,
    createdAt:'2026-02-08T00:00:00Z',updatedAt:new Date().toISOString()
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE & DATA HOOKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={
  get:(k)=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};

function usePreferences(){
  const[prefs,setPrefs]=useState(()=>S.get('icl-prefs'));
  useEffect(()=>{if(prefs)S.set('icl-prefs',prefs)},[prefs]);
  const save=(p)=>setPrefs(p);
  return{prefs,save,isSetup:!!prefs};
}

function useRecipes(prefs){
  const[recipes,setRecipes]=useState(()=>{
    const stored=S.get('icl-recipes');
    const defaultPrefs=prefs||{vanillaPreference:'paste',textureAgentPreference:'none',defaultBatchSize:300};
    if(stored){
      // Update all built-in recipes in-place if prefs changed
      let updated=prefs?stored.map(r=>BUILT_IN_CONFIGS[r.id]?buildBuiltInRecipe(r.id,prefs):r):stored;
      // Add any new built-in recipes that existing users don't have yet
      const existingIds=new Set(updated.map(r=>r.id));
      const missing=BUILT_IN_IDS.filter(id=>!existingIds.has(id));
      if(missing.length) updated=[...updated,...missing.map(id=>buildBuiltInRecipe(id,defaultPrefs))];
      return updated;
    }
    return BUILT_IN_IDS.map(id=>buildBuiltInRecipe(id,defaultPrefs));
  });
  // Re-resolve all built-in recipes when prefs change
  useEffect(()=>{
    if(prefs) setRecipes(p=>p.map(r=>BUILT_IN_CONFIGS[r.id]?{...buildBuiltInRecipe(r.id,prefs),createdAt:r.createdAt}:r));
  },[prefs?.vanillaPreference,prefs?.textureAgentPreference]);
  useEffect(()=>S.set('icl-recipes',recipes),[recipes]);
  return{
    recipes,
    addRecipe:(r)=>setRecipes(p=>[...p,{...r,id:uid(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]),
    updateRecipe:(id,u)=>setRecipes(p=>p.map(r=>r.id===id?{...r,...u,updatedAt:new Date().toISOString()}:r)),
    deleteRecipe:(id)=>setRecipes(p=>p.filter(r=>r.id!==id)),
    duplicateRecipe:(id)=>{setRecipes(p=>{const o=p.find(r=>r.id===id);if(!o)return p;const d={...JSON.parse(JSON.stringify(o)),id:uid(),name:o.name+' (copy)',isBaseline:false,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};d.ingredients=d.ingredients.map(i=>({...i,id:uid()}));d.steps=d.steps.map(s=>({...s,id:uid()}));return[...p,d]})},
    importRecipe:(r)=>setRecipes(p=>[...p,{...r,id:r.id||uid(),createdAt:r.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()}]),
  };
}

function useBatches(){
  const[batches,setBatches]=useState(()=>S.get('icl-batches')||[]);
  useEffect(()=>S.set('icl-batches',batches),[batches]);
  return{
    batches,
    addBatch:(b)=>setBatches(p=>[...p,{...b,id:uid(),createdAt:new Date().toISOString()}]),
    updateBatch:(id,u)=>setBatches(p=>p.map(b=>b.id===id?{...b,...u}:b)),
    deleteBatch:(id)=>setBatches(p=>p.filter(b=>b.id!==id)),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function avgRating(batches,rid){const rb=rid?batches.filter(b=>b.recipeId===rid):batches;if(!rb.length)return 0;return rb.reduce((s,b)=>s+(b.ratings?.overall||0),0)/rb.length}
function batchCount(batches,rid){return batches.filter(b=>b.recipeId===rid).length}
function hasCafe(batches,rid){return batches.some(b=>b.recipeId===rid&&b.cafeWorthy)}
function scaleAmt(amt,orig,target){if(typeof amt==='string')return amt;return Math.round(amt*(target/orig)*100)/100}
function playBeep(){try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.value=800;o.type='sine';g.gain.value=0.3;o.start();setTimeout(()=>{o.frequency.value=1000},200);setTimeout(()=>{o.frequency.value=800},400);setTimeout(()=>{o.stop();ctx.close()},600)}catch{}}
function getStepIngredients(step,allIngredients){if(!step.ingredients?.length)return[];return step.ingredients.map(iid=>allIngredients.find(i=>i.id===iid)).filter(Boolean)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Stars({rating,size=18,onChange}){return(<div className="flex gap-0.5 items-center">{[1,2,3,4,5].map(i=>(<button key={i} onClick={()=>onChange?.(i)} className={onChange?'cursor-pointer':'cursor-default'} style={{fontSize:size,lineHeight:1,color:i<=Math.round(rating)?'#FBBF24':'#D1D5DB',background:'none',border:'none',padding:0}}>â˜…</button>))}</div>)}
function CatBadge({category,small}){return(<span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-white font-semibold text-xs" style={{background:CAT_COLORS[category]||'#888'}}>{CAT_EMOJI[category]} {category}</span>)}
function CafeBadge(){return <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-500 text-white text-xs font-semibold">â˜• cafe worthy</span>}
function PrefBadge({vanilla,agent}){const parts=[];if(vanilla)parts.push(VANILLA_LABELS[vanilla]||vanilla);if(agent&&agent!=='none')parts.push(AGENT_LABELS[agent]||agent);if(!parts.length)return null;return <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 text-xs font-semibold">{parts.join(' Â· ')}</span>}

function Modal({open,onClose,title,children,wide}){if(!open)return null;return(<div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center" onClick={onClose}><div className="fixed inset-0 bg-black/40"/><div className={`relative bg-white rounded-t-2xl sm:rounded-2xl ${wide?'w-full max-w-2xl':'w-full max-w-lg'} max-h-[90vh] overflow-y-auto slide-up`} onClick={e=>e.stopPropagation()}><div className="sticky top-0 bg-white rounded-t-2xl border-b px-5 py-4 flex items-center justify-between z-10"><h2 className="text-lg font-bold">{title}</h2><button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-xl">Ã—</button></div><div className="p-5">{children}</div></div></div>)}
function Confirm({open,onClose,onConfirm,title,message}){if(!open)return null;return(<div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="fixed inset-0 bg-black/40" onClick={onClose}/><div className="relative bg-white rounded-2xl p-6 max-w-sm w-full fade-in"><h3 className="font-bold text-lg mb-2">{title}</h3><p className="text-gray-600 mb-5">{message}</p><div className="flex gap-3 justify-end"><button onClick={onClose} className="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-100 font-medium">Cancel</button><button onClick={()=>{onConfirm();onClose()}} className="px-4 py-2 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600">Delete</button></div></div></div>)}

function RatingSlider({value,onChange,labels,label}){return(<div className="mb-3"><div className="flex justify-between items-center mb-1"><span className="text-sm font-medium text-gray-700">{label}</span><span className="text-sm font-semibold" style={{color:value>=4?'#22C55E':value>=3?'#F59E0B':'#EF4444'}}>{value?labels[value-1]:'â€”'}</span></div><div className="flex gap-1.5">{[1,2,3,4,5].map(i=>(<button key={i} onClick={()=>onChange(i)} className={`flex-1 h-9 rounded-lg font-semibold text-sm transition-all ${i===value?'text-white shadow-md scale-105':'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} style={i===value?{background:i>=4?'#22C55E':i>=3?'#F59E0B':'#EF4444'}:{}}>{i}</button>))}</div><div className="flex justify-between mt-0.5"><span className="text-[10px] text-gray-400">{labels[0]}</span><span className="text-[10px] text-gray-400">{labels[4]}</span></div></div>)}
function EmptyState({emoji,title,desc,action,onAction}){return(<div className="flex flex-col items-center justify-center py-16 px-8 text-center"><div className="text-5xl mb-4">{emoji}</div><h3 className="text-lg font-bold text-gray-700 mb-1">{title}</h3><p className="text-gray-500 text-sm mb-6">{desc}</p>{action&&<button onClick={onAction} className="px-5 py-2.5 bg-accent text-white rounded-xl font-semibold hover:opacity-90">{action}</button>}</div>)}
function Tabs({tabs,active,onChange}){return(<div className="flex gap-1 bg-gray-100 p-1 rounded-xl mb-4">{tabs.map(t=>(<button key={t.key} onClick={()=>onChange(t.key)} className={`flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-all ${active===t.key?'bg-white text-gray-900 shadow-sm':'text-gray-500'}`}>{t.label}</button>))}</div>)}
function FAB({onClick,label}){return(<button onClick={onClick} className="fixed bottom-24 right-5 z-30 w-14 h-14 rounded-full bg-accent text-white shadow-lg hover:shadow-xl flex items-center justify-center text-2xl font-bold transition-all hover:scale-105 active:scale-95" title={label}>+</button>)}
function BackBtn({onClick,label}){return(<button onClick={onClick} className="flex items-center gap-1 text-accent font-semibold text-sm mb-4 hover:opacity-80"><span className="text-lg">â€¹</span> {label||'Back'}</button>)}

// â”€â”€ First Launch Setup â”€â”€
function PreferencesSetup({onSave}){
  const[vanilla,setVanilla]=useState('paste');
  const[agent,setAgent]=useState('none');
  return(
    <div className="min-h-screen bg-surface flex items-center justify-center p-6">
      <div className="max-w-md w-full fade-in">
        <div className="text-center mb-8">
          <div className="text-5xl mb-3">ğŸ¦</div>
          <h1 className="text-2xl font-extrabold text-gray-900 mb-1">Ice Cream Lab</h1>
          <p className="text-gray-500 text-sm">Before your first batch, let's set your preferences</p>
        </div>
        <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4">
          <h3 className="font-bold text-gray-900 mb-3">ğŸŒ¿ Vanilla type</h3>
          <div className="space-y-2">
            {VANILLA_OPTIONS.map(o=>(
              <button key={o.key} onClick={()=>setVanilla(o.key)} className={`w-full text-left px-4 py-3 rounded-xl border-2 transition-all ${vanilla===o.key?'border-accent bg-accent/5':'border-gray-100 hover:border-gray-200'}`}>
                <div className="font-semibold text-sm">{o.label}</div>
                <div className="text-xs text-gray-500">{o.desc}</div>
              </button>
            ))}
          </div>
        </div>
        <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-6">
          <h3 className="font-bold text-gray-900 mb-3">ğŸ§Š Texture agent</h3>
          <div className="space-y-2">
            {TEXTURE_AGENTS.map(o=>(
              <button key={o.key} onClick={()=>setAgent(o.key)} className={`w-full text-left px-4 py-3 rounded-xl border-2 transition-all ${agent===o.key?'border-accent bg-accent/5':'border-gray-100 hover:border-gray-200'}`}>
                <div className="font-semibold text-sm">{o.label}</div>
                <div className="text-xs text-gray-500">{o.desc}</div>
              </button>
            ))}
          </div>
        </div>
        <button onClick={()=>onSave({vanillaPreference:vanilla,textureAgentPreference:agent,tempUnit:'C',defaultBatchSize:300})} className="w-full py-3.5 bg-accent text-white rounded-xl font-bold text-base hover:opacity-90 active:scale-[0.98] transition-all">
          Save & Start Cooking ğŸ”¥
        </button>
      </div>
    </div>
  );
}

// â”€â”€ Preferences Bottom Sheet â”€â”€
function PreferencesSheet({open,onClose,prefs,onSave}){
  const[vanilla,setVanilla]=useState(prefs?.vanillaPreference||'paste');
  const[agent,setAgent]=useState(prefs?.textureAgentPreference||'none');
  const[tempU,setTempU]=useState(prefs?.tempUnit||'C');
  useEffect(()=>{if(open){setVanilla(prefs?.vanillaPreference||'paste');setAgent(prefs?.textureAgentPreference||'none');setTempU(prefs?.tempUnit||'C')}},[open]);
  const handleSave=()=>{onSave({...prefs,vanillaPreference:vanilla,textureAgentPreference:agent,tempUnit:tempU});onClose()};
  return(
    <Modal open={open} onClose={onClose} title="Preferences">
      <div className="mb-4">
        <h4 className="font-semibold text-sm text-gray-700 mb-2">ğŸŒ¿ Vanilla type</h4>
        <div className="flex gap-2">{VANILLA_OPTIONS.map(o=>(
          <button key={o.key} onClick={()=>setVanilla(o.key)} className={`flex-1 py-2 px-2 rounded-lg text-xs font-semibold text-center transition-all ${vanilla===o.key?'bg-accent text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{o.label}</button>
        ))}</div>
      </div>
      <div className="mb-4">
        <h4 className="font-semibold text-sm text-gray-700 mb-2">ğŸ§Š Texture agent</h4>
        <div className="space-y-1.5">{TEXTURE_AGENTS.map(o=>(
          <button key={o.key} onClick={()=>setAgent(o.key)} className={`w-full text-left px-3 py-2 rounded-lg transition-all ${agent===o.key?'bg-accent text-white':'bg-gray-50 hover:bg-gray-100'}`}>
            <span className={`text-sm font-semibold ${agent===o.key?'text-white':'text-gray-700'}`}>{o.label}</span>
            <span className={`text-xs ml-2 ${agent===o.key?'text-white/80':'text-gray-400'}`}>{o.desc}</span>
          </button>
        ))}</div>
      </div>
      <div className="mb-5">
        <h4 className="font-semibold text-sm text-gray-700 mb-2">ğŸŒ¡ï¸ Temperature unit</h4>
        <div className="flex gap-2">{[{k:'C',l:'Â°C (Celsius)'},{k:'F',l:'Â°F (Fahrenheit)'}].map(o=>(
          <button key={o.k} onClick={()=>setTempU(o.k)} className={`flex-1 py-2 px-3 rounded-lg text-sm font-semibold text-center transition-all ${tempU===o.k?'bg-accent text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{o.l}</button>
        ))}</div>
      </div>
      <button onClick={handleSave} className="w-full py-2.5 bg-accent text-white rounded-xl font-semibold">Save Preferences</button>
    </Modal>
  );
}

function PrefsGear({prefs,onClick,dark}){
  return(
    <button onClick={onClick} className={`flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs font-medium transition-all ${dark?'hover:bg-gray-800 text-gray-400':'hover:bg-gray-100 text-gray-500'}`}>
      <span>{VANILLA_LABELS[prefs?.vanillaPreference]||'Paste'} Â· {AGENT_LABELS[prefs?.textureAgentPreference]||'None'}</span>
      <span>âš™ï¸</span>
    </button>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECIPES TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function RecipeCard({recipe,batches,onClick}){
  const avg=avgRating(batches,recipe.id);const count=batchCount(batches,recipe.id);const cafe=hasCafe(batches,recipe.id);
  return(<div onClick={onClick} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all fade-in" style={{borderLeftWidth:4,borderLeftColor:CAT_COLORS[recipe.category]}}>
    <div className="flex items-start justify-between gap-2 mb-2"><h3 className="font-bold text-gray-900 leading-tight">{recipe.name}</h3><CatBadge category={recipe.category} small/></div>
    <div className="flex items-center gap-3 text-sm text-gray-500 flex-wrap">
      {avg>0&&<div className="flex items-center gap-1"><Stars rating={avg} size={14}/><span className="font-medium">{avg.toFixed(1)}</span></div>}
      {count>0&&<span>{count} batch{count>1?'es':''}</span>}
      {cafe&&<CafeBadge/>}
    </div>
    {recipe.tags?.length>0&&(<div className="flex flex-wrap gap-1 mt-2">{recipe.tags.slice(0,4).map(t=><span key={t} className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">#{t}</span>)}</div>)}
  </div>);
}

function RecipeList({recipes,batches,onSelect,onAdd}){
  const[filter,setFilter]=useState('all');const[sort,setSort]=useState('newest');const[search,setSearch]=useState('');
  const filtered=useMemo(()=>{let r=[...recipes];if(filter!=='all')r=r.filter(x=>x.category===filter);if(search){const s=search.toLowerCase();r=r.filter(x=>x.name.toLowerCase().includes(s)||x.tags?.some(t=>t.toLowerCase().includes(s)))}switch(sort){case'name':r.sort((a,b)=>a.name.localeCompare(b.name));break;case'rating':r.sort((a,b)=>avgRating(batches,b.id)-avgRating(batches,a.id));break;case'most-made':r.sort((a,b)=>batchCount(batches,b.id)-batchCount(batches,a.id));break;default:r.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))}return r},[recipes,batches,filter,sort,search]);
  return(<div className="pb-24">
    <div className="mb-4"><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search recipes or tags..." className="w-full px-4 py-2.5 bg-white rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-accent/30"/></div>
    <div className="flex gap-2 mb-3 overflow-x-auto pb-1 -mx-1 px-1">{['all',...CATEGORIES].map(c=>(<button key={c} onClick={()=>setFilter(c)} className={`px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all ${filter===c?'text-white':'bg-gray-100 text-gray-600'}`} style={filter===c?{background:c==='all'?'#FF5722':CAT_COLORS[c]}:{}}>{c==='all'?'All':`${CAT_EMOJI[c]} ${c}`}</button>))}</div>
    <div className="flex gap-2 mb-4">{[['newest','Newest'],['name','Name'],['rating','Rating'],['most-made','Most made']].map(([k,l])=>(<button key={k} onClick={()=>setSort(k)} className={`px-3 py-1 rounded-lg text-xs font-medium ${sort===k?'bg-gray-800 text-white':'bg-gray-100 text-gray-500'}`}>{l}</button>))}</div>
    {filtered.length===0?(<EmptyState emoji="ğŸ“–" title="No recipes yet" desc="Add your first recipe to get started" action="Add Recipe" onAction={onAdd}/>):(<div className="grid gap-3">{filtered.map(r=><RecipeCard key={r.id} recipe={r} batches={batches} onClick={()=>onSelect(r.id)}/>)}</div>)}
    <FAB onClick={onAdd} label="Add recipe"/>
  </div>);
}

function RecipeDetail({recipe,batches,onBack,onEdit,onDuplicate,onDelete,onCook,onViewBatches,onExport,prefs,onOpenPrefs}){
  const[scale,setScale]=useState(recipe.servings);const[showDel,setShowDel]=useState(false);const[showMenu,setShowMenu]=useState(false);
  const[yolkWeight,setYolkWeight]=useState(()=>Math.round(YOLK_REF_G*(recipe.servings/300)));
  const[yolkEdited,setYolkEdited]=useState(false);
  const[scaleInput,setScaleInput]=useState(String(recipe.servings));
  const[yolkInput,setYolkInput]=useState(String(Math.round(YOLK_REF_G*(recipe.servings/300))));
  const avg=avgRating(batches,recipe.id);const count=batchCount(batches,recipe.id);
  const menuRef=useRef(null);
  const tempUnit=prefs?.tempUnit||'C';
  const batchMult=scale/(recipe.servings||300);
  const yolkRef=Math.round(YOLK_REF_G*batchMult);
  const yolkMult=yolkEdited&&recipe.isBaseline?(yolkWeight/yolkRef):1;
  const isScaled=yolkEdited&&yolkMult!==1;
  const scaleIng=(ing)=>{
    if(typeof ing.amount==='string')return ing.amount;
    if(ing.isYolk) return yolkEdited?yolkWeight:Math.round(ing.amount*batchMult);
    const base=ing.amount*batchMult*yolkMult;
    if(ing.category==='stabilizer')return Math.round(base*100)/100;
    return Math.round(base);
  };
  const commitBatch=(v)=>{const val=+v||recipe.servings;setScale(val);setScaleInput(String(val));if(!yolkEdited){const y=Math.round(YOLK_REF_G*(val/300));setYolkWeight(y);setYolkInput(String(y))}};
  const commitYolk=(v)=>{const val=+v||yolkRef;setYolkWeight(val);setYolkInput(String(val));setYolkEdited(true)};
  const resetYolk=()=>{setYolkWeight(yolkRef);setYolkInput(String(yolkRef));setYolkEdited(false)};
  useEffect(()=>{if(!showMenu)return;const h=e=>{if(menuRef.current&&!menuRef.current.contains(e.target))setShowMenu(false)};document.addEventListener('pointerdown',h);return()=>document.removeEventListener('pointerdown',h)},[showMenu]);
  return(<div className="pb-20 fade-in">
    <BackBtn onClick={onBack}/>
    <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4" style={{borderTopWidth:4,borderTopColor:CAT_COLORS[recipe.category]}}>
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1 min-w-0"><h2 className="text-xl font-bold text-gray-900 mb-1">{recipe.name}</h2><div className="flex items-center gap-2 flex-wrap"><CatBadge category={recipe.category}/>{recipe.isBaseline&&<PrefsGear prefs={prefs} onClick={onOpenPrefs}/>}</div></div>
        <div className="relative flex-shrink-0 ml-2" ref={menuRef}>
          <button onClick={()=>setShowMenu(!showMenu)} className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 text-lg">â‹¯</button>
          {showMenu&&(<div className="absolute right-0 top-11 bg-white rounded-xl shadow-lg border border-gray-100 py-1.5 w-44 z-30 fade-in">
            <button onClick={()=>{setShowMenu(false);onEdit()}} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center gap-2"><span>âœï¸</span> Edit recipe</button>
            <button onClick={()=>{setShowMenu(false);onDuplicate()}} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center gap-2"><span>ğŸ“‹</span> Duplicate</button>
            <button onClick={()=>{setShowMenu(false);onExport()}} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center gap-2"><span>ğŸ“¤</span> Export JSON</button>
            <hr className="my-1 border-gray-100"/>
            <button onClick={()=>{setShowMenu(false);setShowDel(true)}} className="w-full text-left px-4 py-2.5 text-sm hover:bg-red-50 text-red-500 flex items-center gap-2"><span>ğŸ—‘ï¸</span> Delete</button>
          </div>)}
        </div>
      </div>
      {avg>0&&<div className="flex items-center gap-2 mb-2"><Stars rating={avg} size={16}/><span className="text-sm font-semibold text-gray-600">{avg.toFixed(1)} ({count} batch{count!==1?'es':''})</span></div>}
      {recipe.calculatedStats&&(recipe.calculatedStats.fatPercent||recipe.calculatedStats.sweetenerPercent||recipe.calculatedStats.totalSolidsPercent)&&(
        <div className="flex gap-3 mb-3 flex-wrap">
          {recipe.calculatedStats.fatPercent&&<div className="bg-blue-50 px-3 py-1.5 rounded-lg"><span className="text-xs text-blue-600 font-semibold">Fat {recipe.calculatedStats.fatPercent}%</span></div>}
          {recipe.calculatedStats.sweetenerPercent&&<div className="bg-amber-50 px-3 py-1.5 rounded-lg"><span className="text-xs text-amber-600 font-semibold">Sweet {recipe.calculatedStats.sweetenerPercent}%</span></div>}
          {recipe.calculatedStats.totalSolidsPercent&&<div className="bg-green-50 px-3 py-1.5 rounded-lg"><span className="text-xs text-green-600 font-semibold">Solids {recipe.calculatedStats.totalSolidsPercent}%</span></div>}
          {recipe.calculatedStats.estimatedCostYen&&<div className="bg-purple-50 px-3 py-1.5 rounded-lg"><span className="text-xs text-purple-600 font-semibold">Â¥{recipe.calculatedStats.estimatedCostYen}</span></div>}
        </div>
      )}
    </div>
    {/* Ingredients */}
    <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4">
      <div className="flex items-center justify-between mb-3"><h3 className="font-bold text-gray-900">Ingredients</h3><div className="flex items-center gap-2"><span className="text-xs text-gray-500">Batch:</span><input type="number" value={scaleInput} onChange={e=>setScaleInput(e.target.value)} onBlur={e=>commitBatch(e.target.value)} min={50} step={50} className="w-20 px-2 py-1 border rounded-lg text-sm text-center font-semibold"/><span className="text-xs text-gray-500">ml</span></div></div>
      {isScaled&&<div className="flex items-center gap-2 mb-3"><span className="text-xs bg-blue-50 text-blue-600 font-semibold px-2 py-0.5 rounded-full">Scaled to yolk weight</span><button onClick={resetYolk} className="text-xs text-accent font-semibold hover:underline">Reset</button></div>}
      <div className="divide-y">{recipe.ingredients.map(ing=>{
        const amt=recipe.isBaseline?scaleIng(ing):scaleAmt(ing.amount,recipe.servings,scale);
        const isYolk=ing.isYolk&&recipe.isBaseline;
        return(<div key={ing.id} className="py-2 flex items-center justify-between">
          <div><span className="font-medium text-gray-900">{ing.name}</span>{ing.nameJa&&<span className="text-xs text-gray-400 ml-2">{ing.nameJa}</span>}</div>
          {isYolk?(<div className="flex items-center gap-1"><input type="number" value={yolkInput} onChange={e=>setYolkInput(e.target.value)} onBlur={e=>commitYolk(e.target.value)} min={10} step={1} className="w-16 px-2 py-1 border-2 border-accent/30 rounded-lg text-sm text-center font-bold text-accent bg-accent/5 focus:border-accent focus:outline-none"/><span className="text-sm font-semibold text-accent">g</span></div>):(<span className={`font-semibold ${isScaled&&!ing.isYolk?'text-blue-600':'text-accent'}`}>{amt} {ing.unit}</span>)}
        </div>)})}</div>
    </div>
    {/* Steps */}
    <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4">
      <h3 className="font-bold text-gray-900 mb-3">Steps</h3>
      <div className="space-y-4">{recipe.steps.sort((a,b)=>a.order-b.order).map((step,i)=>(<div key={step.id} className="flex gap-3"><div className="w-7 h-7 rounded-full bg-accent/10 text-accent flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5">{i+1}</div><div className="flex-1"><div className="font-semibold text-gray-900 mb-0.5">{step.title}</div><p className="text-sm text-gray-600 leading-relaxed">{convertTempsInText(step.instruction,tempUnit)}</p>{step.timerSeconds&&<span className="inline-flex items-center gap-1 text-xs text-accent font-semibold mt-1">â± {Math.round(step.timerSeconds/60)} min</span>}</div></div>))}</div>
    </div>
    {recipe.notes&&(<div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4"><h3 className="font-bold text-gray-900 mb-2">Notes</h3><p className="text-sm text-gray-600 whitespace-pre-line">{recipe.notes}</p></div>)}
    {recipe.source?.rawText&&(<div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4"><h3 className="font-bold text-gray-900 mb-2">Source</h3>{recipe.source.type==='url'&&recipe.source.url&&<a href={recipe.source.url} target="_blank" className="text-accent text-sm underline break-all">{recipe.source.url}</a>}{recipe.source.type==='book'&&<p className="text-sm text-gray-600">{recipe.source.bookTitle} â€” {recipe.source.bookPage}</p>}<p className="text-sm text-gray-500 mt-1 whitespace-pre-line">{recipe.source.rawText}</p></div>)}
    {recipe.tags?.length>0&&(<div className="flex flex-wrap gap-2 mb-4">{recipe.tags.map(t=><span key={t} className="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full">#{t}</span>)}</div>)}
    <div className="flex gap-3">
      <button onClick={onCook} className="flex-1 py-3 bg-accent text-white rounded-xl font-bold text-base hover:opacity-90 active:scale-[0.98] transition-all">ğŸ”¥ Start Cooking</button>
      <button onClick={onViewBatches} className="px-5 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200">ğŸ“‹ Batches ({count})</button>
    </div>
    <Confirm open={showDel} onClose={()=>setShowDel(false)} onConfirm={onDelete} title="Delete recipe?" message={`"${recipe.name}" will be permanently removed.`}/>
  </div>);
}

function RecipeForm({recipe,onSave,onBack}){
  const isEdit=!!recipe;
  const[mode,setMode]=useState('structured');
  const[name,setName]=useState(recipe?.name||'');const[category,setCategory]=useState(recipe?.category||'traditional');
  const[servings,setServings]=useState(recipe?.servings||300);
  const[ingredients,setIngredients]=useState(recipe?.ingredients||[{id:uid(),name:'',nameJa:'',amount:0,unit:'g',category:'dairy'}]);
  const[steps,setSteps]=useState(recipe?.steps||[{id:uid(),order:1,title:'',instruction:'',timerSeconds:null,ingredients:[]}]);
  const[notes,setNotes]=useState(recipe?.notes||'');const[tags,setTags]=useState(recipe?.tags?.join(', ')||'');
  const[sourceType,setSourceType]=useState(recipe?.source?.type||'original');
  const[sourceUrl,setSourceUrl]=useState(recipe?.source?.url||'');
  const[sourceBook,setSourceBook]=useState(recipe?.source?.bookTitle||'');
  const[sourcePage,setSourcePage]=useState(recipe?.source?.bookPage||'');
  const[rawText,setRawText]=useState(recipe?.source?.rawText||'');
  const[fatPct,setFatPct]=useState(recipe?.calculatedStats?.fatPercent||'');
  const[sweetPct,setSweetPct]=useState(recipe?.calculatedStats?.sweetenerPercent||'');
  const[solidsPct,setSolidsPct]=useState(recipe?.calculatedStats?.totalSolidsPercent||'');
  const[costYen,setCostYen]=useState(recipe?.calculatedStats?.estimatedCostYen||'');
  const addIng=()=>setIngredients(p=>[...p,{id:uid(),name:'',nameJa:'',amount:0,unit:'g',category:'dairy'}]);
  const rmIng=(id)=>setIngredients(p=>p.filter(i=>i.id!==id));
  const updIng=(id,f,v)=>setIngredients(p=>p.map(i=>i.id===id?{...i,[f]:v}:i));
  const addStep=()=>setSteps(p=>[...p,{id:uid(),order:p.length+1,title:'',instruction:'',timerSeconds:null,ingredients:[]}]);
  const rmStep=(id)=>setSteps(p=>p.filter(s=>s.id!==id).map((s,i)=>({...s,order:i+1})));
  const updStep=(id,f,v)=>setSteps(p=>p.map(s=>s.id===id?{...s,[f]:v}:s));
  const handleSave=()=>{if(!name.trim())return alert('Recipe name is required');onSave({...(recipe||{}),name:name.trim(),category,servings,ingredients:ingredients.filter(i=>i.name.trim()),steps:steps.filter(s=>s.instruction.trim()).map((s,i)=>({...s,order:i+1})),notes,tags:tags.split(',').map(t=>t.trim()).filter(Boolean),source:{type:sourceType,url:sourceUrl,bookTitle:sourceBook,bookPage:sourcePage,rawText},calculatedStats:{fatPercent:fatPct?+fatPct:null,sweetenerPercent:sweetPct?+sweetPct:null,totalSolidsPercent:solidsPct?+solidsPct:null,estimatedCostYen:costYen?+costYen:null}})};
  return(<div className="pb-20 fade-in">
    <BackBtn onClick={onBack}/><h2 className="text-xl font-bold mb-4">{isEdit?'Edit Recipe':'New Recipe'}</h2>
    <Tabs tabs={[{key:'structured',label:'Structured'},{key:'paste',label:'Paste & Structure'}]} active={mode} onChange={setMode}/>
    {mode==='paste'&&(<div className="mb-4"><label className="text-sm font-semibold text-gray-700 mb-1 block">Paste raw recipe text</label><textarea value={rawText} onChange={e=>setRawText(e.target.value)} rows={6} className="w-full px-3 py-2 border rounded-xl text-sm focus:ring-2 focus:ring-accent/30 focus:outline-none" placeholder="Paste a recipe from a URL, book, or conversation with Claude..."/></div>)}
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 space-y-3">
      <div><label className="text-sm font-semibold text-gray-700 mb-1 block">Name *</label><input value={name} onChange={e=>setName(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm focus:ring-2 focus:ring-accent/30 focus:outline-none"/></div>
      <div className="flex gap-3"><div className="flex-1"><label className="text-sm font-semibold text-gray-700 mb-1 block">Category</label><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm bg-white">{CATEGORIES.map(c=><option key={c} value={c}>{CAT_EMOJI[c]} {c}</option>)}</select></div><div className="w-28"><label className="text-sm font-semibold text-gray-700 mb-1 block">Batch (ml)</label><input type="number" value={servings} onChange={e=>setServings(+e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm"/></div></div>
      <div><label className="text-sm font-semibold text-gray-700 mb-1 block">Source</label><select value={sourceType} onChange={e=>setSourceType(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm bg-white mb-2"><option value="original">Original</option><option value="url">URL</option><option value="book">Book</option><option value="pasted">Pasted</option></select>{sourceType==='url'&&<input value={sourceUrl} onChange={e=>setSourceUrl(e.target.value)} placeholder="https://..." className="w-full px-3 py-2 border rounded-xl text-sm"/>}{sourceType==='book'&&<div className="flex gap-2"><input value={sourceBook} onChange={e=>setSourceBook(e.target.value)} placeholder="Book title" className="flex-1 px-3 py-2 border rounded-xl text-sm"/><input value={sourcePage} onChange={e=>setSourcePage(e.target.value)} placeholder="Page" className="w-20 px-3 py-2 border rounded-xl text-sm"/></div>}</div>
    </div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
      <h3 className="font-bold text-gray-900 mb-3">Ingredients</h3>
      {ingredients.map(ing=>(<div key={ing.id} className="flex flex-wrap gap-2 mb-3 pb-3 border-b border-gray-50 items-end"><div className="flex-1 min-w-[120px]"><label className="text-xs text-gray-500">Name</label><input value={ing.name} onChange={e=>updIng(ing.id,'name',e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div><div className="w-24"><label className="text-xs text-gray-500">Japanese</label><input value={ing.nameJa} onChange={e=>updIng(ing.id,'nameJa',e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div><div className="w-16"><label className="text-xs text-gray-500">Amt</label><input type="number" value={ing.amount} onChange={e=>updIng(ing.id,'amount',+e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div><div className="w-16"><label className="text-xs text-gray-500">Unit</label><select value={ing.unit} onChange={e=>updIng(ing.id,'unit',e.target.value)} className="w-full px-1 py-1.5 border rounded-lg text-xs bg-white">{UNITS.map(u=><option key={u}>{u}</option>)}</select></div><div className="w-24"><label className="text-xs text-gray-500">Type</label><select value={ing.category} onChange={e=>updIng(ing.id,'category',e.target.value)} className="w-full px-1 py-1.5 border rounded-lg text-xs bg-white">{ING_CATS.map(c=><option key={c}>{c}</option>)}</select></div><button onClick={()=>rmIng(ing.id)} className="text-red-400 text-lg pb-1 hover:text-red-600">Ã—</button></div>))}
      <button onClick={addIng} className="text-accent text-sm font-semibold hover:underline">+ Add ingredient</button>
    </div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
      <h3 className="font-bold text-gray-900 mb-3">Steps</h3>
      {steps.map((step,i)=>(<div key={step.id} className="mb-4 pb-4 border-b border-gray-50"><div className="flex items-center gap-2 mb-2"><span className="w-6 h-6 rounded-full bg-accent/10 text-accent text-xs font-bold flex items-center justify-center">{i+1}</span><input value={step.title} onChange={e=>updStep(step.id,'title',e.target.value)} placeholder="Step title" className="flex-1 px-2 py-1.5 border rounded-lg text-sm font-semibold"/><button onClick={()=>rmStep(step.id)} className="text-red-400 hover:text-red-600">Ã—</button></div><textarea value={step.instruction} onChange={e=>updStep(step.id,'instruction',e.target.value)} placeholder="Instructions..." rows={2} className="w-full px-2 py-1.5 border rounded-lg text-sm mb-2"/><div className="flex items-center gap-2"><label className="text-xs text-gray-500">Timer (sec):</label><input type="number" value={step.timerSeconds||''} onChange={e=>updStep(step.id,'timerSeconds',e.target.value?+e.target.value:null)} placeholder="â€”" className="w-20 px-2 py-1 border rounded-lg text-sm"/></div></div>))}
      <button onClick={addStep} className="text-accent text-sm font-semibold hover:underline">+ Add step</button>
    </div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4"><h3 className="font-bold text-gray-900 mb-3">Calculated Stats (optional)</h3><div className="grid grid-cols-2 gap-3"><div><label className="text-xs text-gray-500">Fat %</label><input type="number" value={fatPct} onChange={e=>setFatPct(e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div><div><label className="text-xs text-gray-500">Sweetener %</label><input type="number" value={sweetPct} onChange={e=>setSweetPct(e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div><div><label className="text-xs text-gray-500">Total Solids %</label><input type="number" value={solidsPct} onChange={e=>setSolidsPct(e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div><div><label className="text-xs text-gray-500">Cost Â¥</label><input type="number" value={costYen} onChange={e=>setCostYen(e.target.value)} className="w-full px-2 py-1.5 border rounded-lg text-sm"/></div></div></div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 space-y-3"><div><label className="text-sm font-semibold text-gray-700 mb-1 block">Notes</label><textarea value={notes} onChange={e=>setNotes(e.target.value)} rows={3} className="w-full px-3 py-2 border rounded-xl text-sm"/></div><div><label className="text-sm font-semibold text-gray-700 mb-1 block">Tags (comma separated)</label><input value={tags} onChange={e=>setTags(e.target.value)} placeholder="vanilla, custard-base" className="w-full px-3 py-2 border rounded-xl text-sm"/></div></div>
    <button onClick={handleSave} className="w-full py-3 bg-accent text-white rounded-xl font-bold text-base hover:opacity-90">{isEdit?'Save Changes':'Create Recipe'}</button>
  </div>);
}

function JsonImportModal({open,onClose,onImport}){
  const[json,setJson]=useState('');const[error,setError]=useState('');const[preview,setPreview]=useState(null);
  const handleParse=()=>{try{const p=JSON.parse(json);if(!p.name||!p.ingredients)throw new Error('Missing required fields');setPreview(p);setError('')}catch(e){setError(e.message);setPreview(null)}};
  return(<Modal open={open} onClose={onClose} title="Import Recipe (JSON)" wide><textarea value={json} onChange={e=>{setJson(e.target.value);setError('');setPreview(null)}} rows={10} placeholder="Paste recipe JSON here..." className="w-full px-3 py-2 border rounded-xl text-sm font-mono mb-3 focus:ring-2 focus:ring-accent/30 focus:outline-none"/>{error&&<p className="text-red-500 text-sm mb-3">{error}</p>}{preview&&(<div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-3"><h4 className="font-bold text-green-800 mb-1">{preview.name}</h4><p className="text-sm text-green-700">{preview.category} Â· {preview.ingredients?.length} ingredients Â· {preview.steps?.length} steps</p></div>)}<div className="flex gap-3">{!preview&&<button onClick={handleParse} className="flex-1 py-2 bg-gray-800 text-white rounded-xl font-semibold">Validate JSON</button>}{preview&&<button onClick={()=>{onImport(preview);onClose();setJson('');setPreview(null)}} className="flex-1 py-2 bg-accent text-white rounded-xl font-semibold">Import Recipe</button>}</div></Modal>);
}

function RecipesTab({recipes,batches,nav,addRecipe,updateRecipe,deleteRecipe,duplicateRecipe,importRecipe,prefs,onPrefsChange}){
  const[view,setView]=useState('list');const[selectedId,setSelectedId]=useState(null);const[editId,setEditId]=useState(null);
  const[showImport,setShowImport]=useState(false);const[showAddMenu,setShowAddMenu]=useState(false);
  const[showPrefs,setShowPrefs]=useState(false);
  const selected=recipes.find(r=>r.id===selectedId);const editing=editId?recipes.find(r=>r.id===editId):null;
  if(view==='detail'&&selected)return(<><RecipeDetail recipe={selected} batches={batches} prefs={prefs} onOpenPrefs={()=>setShowPrefs(true)} onBack={()=>setView('list')} onEdit={()=>{setEditId(selected.id);setView('form')}} onDuplicate={()=>{duplicateRecipe(selected.id);setView('list')}} onDelete={()=>{deleteRecipe(selected.id);setView('list')}} onCook={()=>nav('cook-active',{recipeId:selected.id})} onViewBatches={()=>nav('log',{filter:selected.id})} onExport={()=>{const blob=new Blob([JSON.stringify(selected,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${selected.name.replace(/\s+/g,'-')}.json`;a.click()}}/><PreferencesSheet open={showPrefs} onClose={()=>setShowPrefs(false)} prefs={prefs} onSave={onPrefsChange}/></>);
  if(view==='form')return(<RecipeForm recipe={editing} onBack={()=>{setView(editing?'detail':'list');setEditId(null)}} onSave={(data)=>{if(editing){updateRecipe(editing.id,data);setView('detail')}else{addRecipe(data);setView('list')}setEditId(null)}}/>);
  return(<><RecipeList recipes={recipes} batches={batches} onSelect={id=>{setSelectedId(id);setView('detail')}} onAdd={()=>setShowAddMenu(true)}/>{showAddMenu&&(<div className="fixed inset-0 z-40" onClick={()=>setShowAddMenu(false)}><div className="fixed inset-0 bg-black/20"/><div className="fixed bottom-28 right-5 bg-white rounded-2xl shadow-xl p-2 z-50 fade-in w-52" onClick={e=>e.stopPropagation()}><button onClick={()=>{setShowAddMenu(false);setEditId(null);setView('form')}} className="w-full px-4 py-3 text-left text-sm font-semibold hover:bg-gray-50 rounded-xl">ğŸ“ New Recipe</button><button onClick={()=>{setShowAddMenu(false);setShowImport(true)}} className="w-full px-4 py-3 text-left text-sm font-semibold hover:bg-gray-50 rounded-xl">ğŸ“¥ Import JSON</button></div></div>)}<JsonImportModal open={showImport} onClose={()=>setShowImport(false)} onImport={importRecipe}/></>);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COOK TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CookTimer({seconds,onDone}){
  const[remaining,setRemaining]=useState(seconds);const[running,setRunning]=useState(false);const intervalRef=useRef(null);
  useEffect(()=>{if(running&&remaining>0){intervalRef.current=setInterval(()=>{setRemaining(p=>{if(p<=1){clearInterval(intervalRef.current);setRunning(false);playBeep();onDone?.();return 0}return p-1})},1000)}return()=>clearInterval(intervalRef.current)},[running]);
  const mins=Math.floor(remaining/60);const secs=remaining%60;const pct=remaining/seconds;const r=54,circ=2*Math.PI*r;
  return(<div className="flex flex-col items-center gap-3 my-4"><div className={`relative w-36 h-36 ${running&&remaining>0?'timer-pulse':''}`}><svg width="144" height="144" className="transform -rotate-90"><circle cx="72" cy="72" r={r} fill="none" stroke="#374151" strokeWidth="8"/><circle cx="72" cy="72" r={r} fill="none" stroke={remaining===0?'#22C55E':'#FF5722'} strokeWidth="8" strokeDasharray={circ} strokeDashoffset={circ*(1-pct)} strokeLinecap="round" className="transition-all duration-1000 ease-linear"/></svg><div className="absolute inset-0 flex items-center justify-center"><span className="text-3xl font-mono font-bold text-white">{String(mins).padStart(2,'0')}:{String(secs).padStart(2,'0')}</span></div></div><div className="flex gap-3">{remaining>0?(<button onClick={()=>setRunning(!running)} className={`px-8 py-3 rounded-xl font-bold text-base ${running?'bg-amber-500 text-white':'bg-accent text-white'}`}>{running?'â¸ Pause':'â–¶ Start'}</button>):(<div className="px-8 py-3 rounded-xl bg-green-500 text-white font-bold text-base">âœ“ Done!</div>)}<button onClick={()=>{setRemaining(seconds);setRunning(false);clearInterval(intervalRef.current)}} className="px-4 py-3 rounded-xl bg-gray-700 text-gray-300 font-semibold">â†»</button></div></div>);
}

function CookMode({recipe,onExit,onLogBatch,prefs,onOpenPrefs,batchScale,yolkWeight}){
  const[step,setStep]=useState(0);const[completed,setCompleted]=useState(new Set());
  const[showIngredients,setShowIngredients]=useState(false);const[showExitConfirm,setShowExitConfirm]=useState(false);
  const[showNotes,setShowNotes]=useState(false);
  const[finished,setFinished]=useState(false);const wakeLock=useRef(null);const touchStart=useRef(null);
  // Scratchpad â€” persisted per recipe
  const notesKey=`cook-notes-${recipe.id}`;
  const[notes,setNotes]=useState(()=>{try{return localStorage.getItem(notesKey)||''}catch{return''}});
  const saveNotes=useCallback((v)=>{setNotes(v);try{localStorage.setItem(notesKey,v)}catch{}},[notesKey]);
  // Scaling logic â€” mirrors RecipeDetail
  const scale=batchScale||recipe.servings||300;
  const batchMult=scale/(recipe.servings||300);
  const yolkRef=Math.round(YOLK_REF_G*batchMult);
  const yW=yolkWeight||yolkRef;
  const yolkEdited=yolkWeight&&yolkWeight!==yolkRef;
  const yolkMult=yolkEdited&&recipe.isBaseline?(yW/yolkRef):1;
  const cookScaleIng=(ing)=>{
    if(typeof ing.amount==='string')return ing.amount;
    if(ing.isYolk)return yolkEdited?yW:Math.round(ing.amount*batchMult);
    const base=ing.amount*batchMult*yolkMult;
    if(ing.category==='stabilizer')return Math.round(base*100)/100;
    return Math.round(base);
  };
  const sorted=useMemo(()=>[...recipe.steps].sort((a,b)=>a.order-b.order),[recipe.steps]);
  const current=sorted[step];const stepIngs=getStepIngredients(current,recipe.ingredients);
  useEffect(()=>{(async()=>{try{wakeLock.current=await navigator.wakeLock?.request('screen')}catch{}try{document.documentElement.requestFullscreen?.({navigationUI:'hide'})}catch{}})();return()=>{wakeLock.current?.release();if(document.fullscreenElement)document.exitFullscreen?.().catch(()=>{})}},[]);
  const goNext=useCallback(()=>{if(step<sorted.length-1){setCompleted(p=>new Set(p).add(step));setStep(step+1)}else{setCompleted(p=>new Set(p).add(step));setFinished(true)}},[step,sorted.length]);
  const goPrev=useCallback(()=>{if(step>0)setStep(step-1)},[step]);
  const onTouchStart=useCallback(e=>{touchStart.current={x:e.touches[0].clientX,y:e.touches[0].clientY}},[]);
  const onTouchEnd=useCallback(e=>{if(!touchStart.current)return;const dx=e.changedTouches[0].clientX-touchStart.current.x;const dy=e.changedTouches[0].clientY-touchStart.current.y;if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>60){if(dx<0)goNext();else goPrev()}touchStart.current=null},[goNext,goPrev]);
  useEffect(()=>{const h=e=>{if(e.key==='ArrowRight'||e.key===' '){e.preventDefault();goNext()}if(e.key==='ArrowLeft'){e.preventDefault();goPrev()}};window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h)},[goNext,goPrev]);

  if(finished)return(<div className="cook-mode fixed inset-0 z-[100] flex flex-col items-center justify-center p-8 text-center"><div className="text-6xl mb-6">ğŸ‰</div><h2 className="text-2xl font-bold mb-2">All done!</h2><p className="text-gray-400 mb-8">How did it go? Log this batch to track your progress.</p><button onClick={()=>onLogBatch(notes)} className="px-8 py-4 bg-accent text-white rounded-2xl font-bold text-lg mb-4 hover:opacity-90">ğŸ“‹ Log This Batch</button><button onClick={onExit} className="text-gray-500 hover:text-gray-300">Skip for now</button></div>);

  return(<div className="cook-mode fixed inset-0 z-[100] flex flex-col" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
    <div className="flex items-center justify-between px-4 py-3 border-b border-gray-800 flex-shrink-0">
      <button onClick={()=>setShowExitConfirm(true)} className="text-gray-400 hover:text-white font-semibold text-sm min-w-[48px] min-h-[48px] flex items-center">âœ• Exit</button>
      <span className="text-sm text-gray-400 font-medium truncate mx-2">{recipe.name}</span>
      <div className="flex items-center gap-1">
        <button onClick={()=>setShowNotes(true)} className="text-gray-400 hover:text-white text-sm min-w-[44px] min-h-[48px] flex items-center justify-center relative">ğŸ“{notes&&<span className="absolute -top-0.5 -right-0.5 w-2 h-2 bg-accent rounded-full"/>}</button>
        {prefs&&<PrefsGear prefs={prefs} onClick={onOpenPrefs} dark/>}
        <button onClick={()=>setShowIngredients(true)} className="text-accent font-semibold text-sm min-w-[48px] min-h-[48px] flex items-center justify-end">ğŸ“‹</button>
      </div>
    </div>
    <div className="flex gap-1 px-4 py-3 flex-shrink-0">{sorted.map((s,i)=>(<button key={s.id} onClick={()=>setStep(i)} className={`flex-1 h-3 rounded-full transition-all ${i<step?'bg-green-500':i===step?'bg-accent':'bg-gray-700'} active:opacity-70`} title={s.title}/>))}</div>
    <div className="flex-1 overflow-y-auto px-5 py-4">
      <div className="text-accent font-bold text-sm mb-2">Step {step+1} of {sorted.length}</div>
      <h2 className="text-2xl font-bold mb-4">{current.title}</h2>
      {stepIngs.length>0&&(<div className="bg-gray-800/50 rounded-xl p-4 mb-4">{stepIngs.map(ing=>(<div key={ing.id} className="flex justify-between py-1.5 text-sm"><span className="text-gray-300">{ing.name}</span><span className="text-accent font-bold">{recipe.isBaseline?cookScaleIng(ing):scaleAmt(ing.amount,recipe.servings,scale)} {ing.unit}</span></div>))}</div>)}
      <p className="text-lg leading-relaxed text-gray-200 mb-6">{convertTempsInText(current.instruction,prefs?.tempUnit)}</p>
      {current.timerSeconds&&<CookTimer seconds={current.timerSeconds} onDone={()=>{}}/>}
      <div className="text-center text-gray-600 text-xs mt-4 pb-2">Tap progress bar to jump Â· Swipe to navigate</div>
    </div>
    <div className="px-4 pt-3 pb-4 border-t border-gray-800 flex gap-3 flex-shrink-0 bg-gray-900">
      <button onClick={goPrev} disabled={step===0} className={`w-20 py-3.5 rounded-xl font-bold text-sm min-h-[48px] ${step===0?'bg-gray-800 text-gray-600':'bg-gray-700 text-white active:bg-gray-600'}`}>â† Prev</button>
      {step<sorted.length-1?(<button onClick={goNext} className="flex-1 py-3.5 bg-accent text-white rounded-xl font-bold text-base min-h-[48px] hover:opacity-90 active:scale-[0.98] transition-all">Next â†’</button>):(<button onClick={goNext} className="flex-1 py-3.5 bg-green-500 text-white rounded-xl font-bold text-base min-h-[48px] hover:opacity-90 active:scale-[0.98] transition-all">Finish âœ“</button>)}
    </div>
    {showIngredients&&(<div className="fixed inset-0 z-[110] bg-gray-900/95 flex flex-col"><div className="flex items-center justify-between px-5 py-4 border-b border-gray-700"><h3 className="font-bold text-lg">All Ingredients{scale!==recipe.servings&&<span className="text-sm text-accent font-medium ml-2">({scale}ml batch)</span>}</h3><button onClick={()=>setShowIngredients(false)} className="text-gray-400 hover:text-white text-xl min-w-[48px] min-h-[48px] flex items-center justify-center">Ã—</button></div><div className="flex-1 overflow-y-auto px-5 py-4">{recipe.ingredients.map(ing=>(<div key={ing.id} className="flex justify-between py-2.5 border-b border-gray-800"><div><span className="text-gray-200">{ing.name}</span>{ing.nameJa&&<span className="text-gray-500 text-sm ml-2">{ing.nameJa}</span>}</div><span className="text-accent font-bold">{recipe.isBaseline?cookScaleIng(ing):scaleAmt(ing.amount,recipe.servings,scale)} {ing.unit}</span></div>))}</div></div>)}
    {showNotes&&(<div className="fixed inset-0 z-[110] bg-gray-900/95 flex flex-col"><div className="flex items-center justify-between px-5 py-4 border-b border-gray-700"><h3 className="font-bold text-lg">ğŸ“ Cook Notes</h3><button onClick={()=>setShowNotes(false)} className="text-gray-400 hover:text-white text-xl min-w-[48px] min-h-[48px] flex items-center justify-center">Ã—</button></div><div className="flex-1 overflow-y-auto px-5 py-4"><p className="text-gray-400 text-sm mb-3">Jot notes as you cook. These will pre-fill the batch log when you finish.</p><textarea value={notes} onChange={e=>saveNotes(e.target.value)} placeholder="How does the custard look? Any tweaks you made? Temperature readings..." rows={12} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-gray-100 text-base leading-relaxed focus:outline-none focus:border-accent resize-none" autoFocus/></div></div>)}
    {showExitConfirm&&(<div className="fixed inset-0 z-[110] flex items-center justify-center p-4"><div className="fixed inset-0 bg-black/60" onClick={()=>setShowExitConfirm(false)}/><div className="relative bg-gray-800 rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg mb-2">Exit cook mode?</h3><p className="text-gray-400 mb-5">Your progress won't be saved.</p><div className="flex gap-3"><button onClick={()=>setShowExitConfirm(false)} className="flex-1 py-3 rounded-xl bg-gray-700 text-white font-semibold min-h-[48px]">Stay</button><button onClick={onExit} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-semibold min-h-[48px]">Exit</button></div></div></div>)}
  </div>);
}

function CookTab({recipes,batches,nav,initialRecipeId,onCookingChange,prefs,onPrefsChange}){
  const[selectedId,setSelectedId]=useState(initialRecipeId||null);const[cooking,setCooking]=useState(false);const[search,setSearch]=useState('');
  const[showPrefs,setShowPrefs]=useState(false);
  const[batchScale,setBatchScale]=useState(300);const[yolkWeight,setYolkWeight]=useState(YOLK_REF_G);
  const recipe=recipes.find(r=>r.id===selectedId);
  const startCooking=(id)=>{const r=recipes.find(x=>x.id===id);const sv=r?.servings||300;setSelectedId(id);setBatchScale(sv);setYolkWeight(Math.round(YOLK_REF_G*(sv/300)));setCooking(true);onCookingChange?.(true)};
  const stopCooking=()=>{setCooking(false);setSelectedId(null);onCookingChange?.(false)};
  useEffect(()=>{if(initialRecipeId){startCooking(initialRecipeId)}},[]);
  if(cooking&&recipe)return(<><CookMode recipe={recipe} prefs={prefs} onOpenPrefs={()=>setShowPrefs(true)} onExit={stopCooking} batchScale={batchScale} yolkWeight={yolkWeight} onLogBatch={(cookNotes)=>{stopCooking();try{localStorage.removeItem(`cook-notes-${recipe.id}`)}catch{};nav('log-add',{recipeId:recipe.id,cookNotes:cookNotes||'',yolkWeightG:yolkWeight,scaledFromBatchMl:batchScale})}}/><PreferencesSheet open={showPrefs} onClose={()=>setShowPrefs(false)} prefs={prefs} onSave={onPrefsChange}/></>);
  const filtered=search?recipes.filter(r=>r.name.toLowerCase().includes(search.toLowerCase())):recipes;
  return(<div className="pb-20"><h2 className="text-xl font-bold mb-4">ğŸ”¥ Start Cooking</h2><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search recipes..." className="w-full px-4 py-2.5 bg-white rounded-xl border border-gray-200 text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-accent/30"/>{filtered.length===0?(<EmptyState emoji="ğŸ“–" title="No recipes" desc="Add recipes first to start cooking"/>):(<div className="grid gap-3">{filtered.map(r=>(<button key={r.id} onClick={()=>startCooking(r.id)} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 text-left hover:shadow-md transition-all" style={{borderLeftWidth:4,borderLeftColor:CAT_COLORS[r.category]}}><div className="flex items-center justify-between"><div><h3 className="font-bold text-gray-900">{r.name}</h3><span className="text-sm text-gray-500">{r.steps?.length||0} steps Â· {r.ingredients?.length||0} ingredients</span></div><span className="text-2xl">â–¶</span></div></button>))}</div>)}</div>);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function BatchCard({batch,recipe,onClick}){
  return(<div onClick={onClick} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all fade-in" style={{borderLeftWidth:4,borderLeftColor:recipe?CAT_COLORS[recipe.category]:'#888'}}>
    <div className="flex items-start justify-between mb-2"><div><div className="text-xs text-gray-400 font-medium mb-0.5">{fmt(batch.date)}</div><h3 className="font-bold text-gray-900">{recipe?.name||'Unknown recipe'}</h3></div><div className="flex items-center gap-2 flex-wrap justify-end">{batch.cafeWorthy&&<CafeBadge/>}{recipe&&<CatBadge category={recipe.category} small/>}</div></div>
    <div className="flex items-center gap-2 flex-wrap">
      <Stars rating={batch.ratings?.overall||0} size={14}/>
      {batch.photoUrl&&<span className="text-xs text-gray-400">ğŸ“·</span>}
      {batch.modifications&&<span className="text-xs text-amber-600 font-medium">modified</span>}
      <PrefBadge vanilla={batch.vanillaUsed} agent={batch.textureAgentUsed}/>
    </div>
    {batch.flavorNotes&&<p className="text-sm text-gray-500 mt-1 line-clamp-1">{batch.flavorNotes}</p>}
  </div>);
}

function BatchForm({recipes,editBatch,initialRecipeId,onSave,onBack,prefs,initialCookNotes,initialYolkWeightG,initialScaledFromBatchMl}){
  const isEdit=!!editBatch;
  const[recipeId,setRecipeId]=useState(editBatch?.recipeId||initialRecipeId||'');
  const[date,setDate]=useState(editBatch?.date||new Date().toISOString().split('T')[0]);
  const[modifications,setModifications]=useState(editBatch?.modifications||'');
  const[overall,setOverall]=useState(editBatch?.ratings?.overall||0);
  const[texture,setTexture]=useState(editBatch?.ratings?.texture||0);
  const[sweetness,setSweetness]=useState(editBatch?.ratings?.sweetness||0);
  const[scoopability,setScoopability]=useState(editBatch?.ratings?.scoopability||0);
  const[flavor,setFlavor]=useState(editBatch?.ratings?.flavor||0);
  const[cafeWorthy,setCafeWorthy]=useState(editBatch?.cafeWorthy||false);
  const[churningTime,setChurningTime]=useState(editBatch?.churningTime||'');
  const[churningNotes,setChurningNotes]=useState(editBatch?.churningNotes||'');
  const[flavorNotes,setFlavorNotes]=useState(editBatch?.flavorNotes||(initialCookNotes||''));
  const[textureNotes,setTextureNotes]=useState(editBatch?.textureNotes||'');
  const[custardTemp,setCustardTemp]=useState(editBatch?.temperature?.custardTemp||'');
  const[preChurnTemp,setPreChurnTemp]=useState(editBatch?.temperature?.preChurnTemp||'');
  const[photoUrl,setPhotoUrl]=useState(editBatch?.photoUrl||null);
  const fileRef=useRef(null);
  const handlePhoto=(e)=>{const file=e.target.files?.[0];if(!file)return;const reader=new FileReader();reader.onload=(ev)=>{const img=new Image();img.onload=()=>{const max=800;let w=img.width,h=img.height;if(w>max){h=h*(max/w);w=max}if(h>max){w=w*(max/h);h=max}const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);setPhotoUrl(c.toDataURL('image/jpeg',0.7))};img.src=ev.target.result};reader.readAsDataURL(file)};
  const handleSave=()=>{if(!recipeId)return alert('Please select a recipe');if(!overall)return alert('Please rate the batch overall');onSave({...(editBatch||{}),recipeId,date,modifications,cafeWorthy,ratings:{overall,texture,sweetness,scoopability,flavor},churningTime:churningTime?+churningTime:null,churningNotes,flavorNotes,textureNotes,temperature:{custardTemp:custardTemp?+custardTemp:null,preChurnTemp:preChurnTemp?+preChurnTemp:null},photoUrl,vanillaUsed:editBatch?.vanillaUsed||(prefs?.vanillaPreference||null),textureAgentUsed:editBatch?.textureAgentUsed||(prefs?.textureAgentPreference||null),yolkWeightG:editBatch?.yolkWeightG||initialYolkWeightG||null,scaledFromBatchMl:editBatch?.scaledFromBatchMl||initialScaledFromBatchMl||300})};
  return(<div className="pb-20 fade-in">
    <BackBtn onClick={onBack}/><h2 className="text-xl font-bold mb-4">{isEdit?'Edit Batch':'Log Batch'}</h2>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 space-y-3">
      <div><label className="text-sm font-semibold text-gray-700 mb-1 block">Recipe *</label><select value={recipeId} onChange={e=>setRecipeId(e.target.value)} className="w-full px-3 py-2.5 border rounded-xl text-sm bg-white"><option value="">Select recipe...</option>{recipes.map(r=><option key={r.id} value={r.id}>{CAT_EMOJI[r.category]} {r.name}</option>)}</select></div>
      <div><label className="text-sm font-semibold text-gray-700 mb-1 block">Date</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm"/></div>
      <div><label className="text-sm font-semibold text-gray-700 mb-1 block">Modifications</label><textarea value={modifications} onChange={e=>setModifications(e.target.value)} rows={2} placeholder="What did you change from the recipe?" className="w-full px-3 py-2 border rounded-xl text-sm"/></div>
      {prefs&&<div className="bg-indigo-50 border border-indigo-100 rounded-xl px-4 py-2.5"><div className="text-xs font-semibold text-indigo-700 mb-0.5">Active preferences</div><div className="text-sm text-indigo-600">{VANILLA_LABELS[prefs.vanillaPreference]||'â€”'} vanilla Â· {AGENT_LABELS[prefs.textureAgentPreference]||'None'} texture agent</div></div>}
    </div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4"><h3 className="font-bold text-gray-900 mb-3">Ratings</h3><RatingSlider value={overall} onChange={setOverall} label="Overall" labels={RATING_LABELS.overall}/><RatingSlider value={texture} onChange={setTexture} label="Texture" labels={RATING_LABELS.texture}/><RatingSlider value={sweetness} onChange={setSweetness} label="Sweetness" labels={RATING_LABELS.sweetness}/><RatingSlider value={scoopability} onChange={setScoopability} label="Scoopability" labels={RATING_LABELS.scoopability}/><RatingSlider value={flavor} onChange={setFlavor} label="Flavor" labels={RATING_LABELS.flavor}/><div className="flex items-center gap-3 mt-4 pt-3 border-t"><button onClick={()=>setCafeWorthy(!cafeWorthy)} className={`px-4 py-2.5 rounded-xl font-semibold text-sm transition-all ${cafeWorthy?'bg-green-500 text-white':'bg-gray-100 text-gray-500'}`}>â˜• {cafeWorthy?'Cafe Worthy!':'Cafe Worthy?'}</button><span className="text-xs text-gray-400">Would you serve this at the cafe?</span></div></div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 space-y-3"><h3 className="font-bold text-gray-900 mb-1">Notes</h3><div><label className="text-xs text-gray-500">Flavor notes</label><textarea value={flavorNotes} onChange={e=>setFlavorNotes(e.target.value)} rows={2} className="w-full px-3 py-2 border rounded-xl text-sm"/></div><div><label className="text-xs text-gray-500">Texture notes</label><textarea value={textureNotes} onChange={e=>setTextureNotes(e.target.value)} rows={2} className="w-full px-3 py-2 border rounded-xl text-sm"/></div><div><label className="text-xs text-gray-500">Churning notes</label><textarea value={churningNotes} onChange={e=>setChurningNotes(e.target.value)} rows={2} className="w-full px-3 py-2 border rounded-xl text-sm"/></div><div className="flex gap-3"><div className="flex-1"><label className="text-xs text-gray-500">Churning time (min)</label><input type="number" value={churningTime} onChange={e=>setChurningTime(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm"/></div><div className="flex-1"><label className="text-xs text-gray-500">Custard {prefs?.tempUnit==='F'?'Â°F':'Â°C'}</label><input type="number" value={custardTemp} onChange={e=>setCustardTemp(e.target.value)} placeholder={prefs?.tempUnit==='F'?'180':'82'} className="w-full px-3 py-2 border rounded-xl text-sm"/></div><div className="flex-1"><label className="text-xs text-gray-500">Pre-churn {prefs?.tempUnit==='F'?'Â°F':'Â°C'}</label><input type="number" value={preChurnTemp} onChange={e=>setPreChurnTemp(e.target.value)} placeholder={prefs?.tempUnit==='F'?'50':'10'} className="w-full px-3 py-2 border rounded-xl text-sm"/></div></div></div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
      <h3 className="font-bold text-gray-900 mb-2">Photo</h3>
      <input ref={fileRef} type="file" accept="image/*" capture="environment" onChange={handlePhoto} className="hidden"/>
      {photoUrl?(<div className="relative"><img src={photoUrl} alt="Batch photo" className="w-full rounded-xl object-cover max-h-64"/><button onClick={()=>setPhotoUrl(null)} className="absolute top-2 right-2 w-8 h-8 bg-black/60 text-white rounded-full flex items-center justify-center text-sm hover:bg-black/80">âœ•</button></div>):(<div className="flex gap-2"><button onClick={()=>fileRef.current?.click()} className="flex-1 py-8 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-accent hover:text-accent transition-all flex flex-col items-center gap-1"><span className="text-2xl">ğŸ“·</span><span className="text-xs font-semibold">Take photo or choose from gallery</span></button></div>)}
    </div>
    <button onClick={handleSave} className="w-full py-3 bg-accent text-white rounded-xl font-bold text-base hover:opacity-90">{isEdit?'Save Changes':'Log Batch'}</button>
  </div>);
}

function BatchDetail({batch,recipe,allBatches,recipes,onBack,onEdit,onDelete,onCompare,onShare}){
  const[showDel,setShowDel]=useState(false);const dims=['overall','texture','sweetness','scoopability','flavor'];
  return(<div className="pb-20 fade-in">
    <BackBtn onClick={onBack}/>
    <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4" style={{borderTopWidth:4,borderTopColor:recipe?CAT_COLORS[recipe.category]:'#888'}}>
      <div className="flex items-start justify-between mb-3"><div><div className="text-sm text-gray-400 mb-0.5">{fmt(batch.date)}</div><h2 className="text-xl font-bold">{recipe?.name||'Unknown'}</h2>{recipe&&<CatBadge category={recipe.category}/>}</div><div className="flex gap-1"><button onClick={onEdit} className="p-2 rounded-lg hover:bg-gray-100 text-gray-500">âœï¸</button><button onClick={onShare} className="p-2 rounded-lg hover:bg-gray-100 text-gray-500">ğŸ“¤</button><button onClick={()=>setShowDel(true)} className="p-2 rounded-lg hover:bg-gray-100 text-red-400">ğŸ—‘ï¸</button></div></div>
      <div className="flex items-center gap-2 mb-3 flex-wrap">{batch.cafeWorthy&&<CafeBadge/>}<PrefBadge vanilla={batch.vanillaUsed} agent={batch.textureAgentUsed}/></div>
      <div className="space-y-2 mb-4">{dims.map(d=>(<div key={d} className="flex items-center gap-2"><span className="text-xs text-gray-500 w-20 capitalize">{d}</span><div className="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden"><div className="h-full rounded-full transition-all" style={{width:`${(batch.ratings?.[d]||0)*20}%`,background:(batch.ratings?.[d]||0)>=4?'#22C55E':(batch.ratings?.[d]||0)>=3?'#F59E0B':'#EF4444'}}/></div><span className="text-xs font-bold w-12 text-right">{batch.ratings?.[d]?RATING_LABELS[d][batch.ratings[d]-1]:'â€”'}</span></div>))}</div>
    </div>
    {batch.photoUrl&&(<div className="mb-4"><img src={batch.photoUrl} alt="Batch photo" className="w-full rounded-2xl object-cover max-h-72 shadow-sm"/></div>)}
    {batch.modifications&&(<div className="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-4"><h4 className="font-bold text-amber-800 text-sm mb-1">âš¡ Modifications</h4><p className="text-sm text-amber-700">{batch.modifications}</p></div>)}
    {(batch.flavorNotes||batch.textureNotes||batch.churningNotes)&&(<div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4 space-y-3">{batch.flavorNotes&&<div><h4 className="font-semibold text-sm text-gray-700">Flavor</h4><p className="text-sm text-gray-600">{batch.flavorNotes}</p></div>}{batch.textureNotes&&<div><h4 className="font-semibold text-sm text-gray-700">Texture</h4><p className="text-sm text-gray-600">{batch.textureNotes}</p></div>}{batch.churningNotes&&<div><h4 className="font-semibold text-sm text-gray-700">Churning</h4><p className="text-sm text-gray-600">{batch.churningNotes}</p></div>}{batch.churningTime&&<p className="text-xs text-gray-400">Churning time: {batch.churningTime} min</p>}{(batch.temperature?.custardTemp||batch.temperature?.preChurnTemp)&&(<p className="text-xs text-gray-400">{batch.temperature.custardTemp&&`Custard: ${batch.temperature.custardTemp}Â°C`}{batch.temperature.custardTemp&&batch.temperature.preChurnTemp&&' Â· '}{batch.temperature.preChurnTemp&&`Pre-churn: ${batch.temperature.preChurnTemp}Â°C`}</p>)}</div>)}
    <button onClick={onCompare} className="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold mb-2 hover:bg-gray-200">âš–ï¸ Compare with another batch</button>
    <Confirm open={showDel} onClose={()=>setShowDel(false)} onConfirm={onDelete} title="Delete batch?" message="This batch log will be permanently removed."/>
  </div>);
}

function BatchCompare({batch1,batch2,recipe1,recipe2,onBack}){
  const dims=['overall','texture','sweetness','scoopability','flavor'];
  return(<div className="pb-20 fade-in">
    <BackBtn onClick={onBack} label="Back to batch"/><h2 className="text-xl font-bold mb-4">âš–ï¸ Compare Batches</h2>
    <div className="grid grid-cols-2 gap-3 mb-4">{[{b:batch1,r:recipe1},{b:batch2,r:recipe2}].map(({b,r},i)=>(<div key={i} className="bg-white rounded-xl p-3 border shadow-sm" style={{borderTopWidth:3,borderTopColor:r?CAT_COLORS[r.category]:'#888'}}><div className="text-xs text-gray-400">{fmt(b.date)}</div><div className="font-bold text-sm">{r?.name||'Unknown'}</div><div className="flex gap-1 mt-1 flex-wrap">{b.cafeWorthy&&<CafeBadge/>}<PrefBadge vanilla={b.vanillaUsed} agent={b.textureAgentUsed}/></div></div>))}</div>
    <div className="bg-white rounded-2xl p-4 shadow-sm border mb-4"><h3 className="font-bold text-sm mb-3">Ratings Comparison</h3>{dims.map(d=>(<div key={d} className="mb-3"><div className="text-xs text-gray-500 capitalize mb-1">{d}</div><div className="flex items-center gap-2"><span className="text-xs font-bold w-5">{batch1.ratings?.[d]||0}</span><div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden flex"><div className="h-full bg-blue-400 rounded-l-full" style={{width:`${(batch1.ratings?.[d]||0)*20}%`}}/></div><div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden flex justify-end"><div className="h-full bg-purple-400 rounded-r-full" style={{width:`${(batch2.ratings?.[d]||0)*20}%`}}/></div><span className="text-xs font-bold w-5 text-right">{batch2.ratings?.[d]||0}</span></div></div>))}<div className="flex justify-center gap-6 text-xs text-gray-400 mt-2"><span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-blue-400 inline-block"></span> Batch 1</span><span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-purple-400 inline-block"></span> Batch 2</span></div></div>
    {(batch1.modifications||batch2.modifications)&&(<div className="bg-white rounded-2xl p-4 shadow-sm border mb-4"><h3 className="font-bold text-sm mb-3">Modifications</h3><div className="grid grid-cols-2 gap-3 text-sm"><div className="text-gray-600">{batch1.modifications||<span className="text-gray-300 italic">None</span>}</div><div className="text-gray-600">{batch2.modifications||<span className="text-gray-300 italic">None</span>}</div></div></div>)}
  </div>);
}

function LogTab({recipes,batches,addBatch,updateBatch,deleteBatch,nav,initialFilter,initialView,initialRecipeId,prefs,initialCookNotes,initialYolkWeightG,initialScaledFromBatchMl}){
  const[view,setView]=useState(initialView||'list');const[selectedId,setSelectedId]=useState(null);const[compareId,setCompareId]=useState(null);
  const[editBatch,setEditBatch]=useState(null);const[filterCat,setFilterCat]=useState('all');const[filterRecipe,setFilterRecipe]=useState(initialFilter||'');
  const[filterCafe,setFilterCafe]=useState('all');const[filterAgent,setFilterAgent]=useState('all');const[minRating,setMinRating]=useState(0);
  const[showFilters,setShowFilters]=useState(false);const[search,setSearch]=useState('');const[selectingCompare,setSelectingCompare]=useState(false);const[shareText,setShareText]=useState('');
  const selected=batches.find(b=>b.id===selectedId);const compareBatch=batches.find(b=>b.id===compareId);
  const filtered=useMemo(()=>{let b=[...batches].sort((a,c)=>new Date(c.date)-new Date(a.date));if(filterCat!=='all')b=b.filter(x=>{const r=recipes.find(r=>r.id===x.recipeId);return r?.category===filterCat});if(filterRecipe)b=b.filter(x=>x.recipeId===filterRecipe);if(filterCafe!=='all')b=b.filter(x=>filterCafe==='yes'?x.cafeWorthy:!x.cafeWorthy);if(filterAgent!=='all')b=b.filter(x=>x.textureAgentUsed===filterAgent);if(minRating>0)b=b.filter(x=>(x.ratings?.overall||0)>=minRating);if(search){const s=search.toLowerCase();b=b.filter(x=>x.flavorNotes?.toLowerCase().includes(s)||x.textureNotes?.toLowerCase().includes(s)||x.modifications?.toLowerCase().includes(s))}return b},[batches,recipes,filterCat,filterRecipe,filterCafe,filterAgent,minRating,search]);

  if(view==='add'||view==='edit')return(<BatchForm recipes={recipes} editBatch={view==='edit'?editBatch:null} initialRecipeId={initialRecipeId} initialCookNotes={view==='add'?initialCookNotes:''} initialYolkWeightG={initialYolkWeightG} initialScaledFromBatchMl={initialScaledFromBatchMl} prefs={prefs} onBack={()=>setView('list')} onSave={data=>{if(view==='edit')updateBatch(editBatch.id,data);else addBatch(data);setView('list')}}/>);
  if(view==='compare'&&selected&&compareBatch)return(<BatchCompare batch1={selected} batch2={compareBatch} recipe1={recipes.find(r=>r.id===selected.recipeId)} recipe2={recipes.find(r=>r.id===compareBatch.recipeId)} onBack={()=>{setView('detail');setCompareId(null)}}/>);
  if(view==='detail'&&selected)return(<BatchDetail batch={selected} recipe={recipes.find(r=>r.id===selected.recipeId)} allBatches={batches} recipes={recipes} onBack={()=>setView('list')} onEdit={()=>{setEditBatch(selected);setView('edit')}} onDelete={()=>{deleteBatch(selected.id);setView('list')}} onCompare={()=>setSelectingCompare(true)} onShare={()=>{const recipe=recipes.find(r=>r.id===selected.recipeId);const batchNum=batches.filter(b=>new Date(b.createdAt)<=new Date(selected.createdAt)).length;const rBar=v=>'â–ˆ'.repeat(v)+'â–‘'.repeat(5-v);const text=`ğŸ¦ Ice Cream Lab â€” Batch #${batchNum}\n\nRecipe: ${recipe?.name||'Unknown'}\nCategory: ${recipe?.category||'?'}\nVanilla: ${VANILLA_LABELS[selected.vanillaUsed]||'â€”'} | Agent: ${AGENT_LABELS[selected.textureAgentUsed]||'None'}\nRating: ${'â˜…'.repeat(selected.ratings.overall)}${'â˜†'.repeat(5-selected.ratings.overall)}\n\nTexture: ${rBar(selected.ratings.texture)} ${RATING_LABELS.texture[selected.ratings.texture-1]||''}\nSweetness: ${rBar(selected.ratings.sweetness)} ${RATING_LABELS.sweetness[selected.ratings.sweetness-1]||''}\nScoopability: ${rBar(selected.ratings.scoopability)} ${RATING_LABELS.scoopability[selected.ratings.scoopability-1]||''}\nFlavor: ${rBar(selected.ratings.flavor)} ${RATING_LABELS.flavor[selected.ratings.flavor-1]||''}\n${selected.modifications?`\nModifications: ${selected.modifications}`:''}${selected.flavorNotes?`\nNotes: ${selected.flavorNotes}`:''}\n\nCafe worthy? ${selected.cafeWorthy?'âœ…':'âŒ'}\n\n#IceCreamLab #HomemadeIceCream`;setShareText(text)}}/>);
  if(selectingCompare)return(<div className="pb-20 fade-in"><BackBtn onClick={()=>setSelectingCompare(false)} label="Cancel"/><h2 className="text-xl font-bold mb-4">Select batch to compare</h2><div className="grid gap-3">{batches.filter(b=>b.id!==selectedId).map(b=>(<BatchCard key={b.id} batch={b} recipe={recipes.find(r=>r.id===b.recipeId)} onClick={()=>{setCompareId(b.id);setSelectingCompare(false);setView('compare')}}/>))}</div></div>);

  return(<div className="pb-20">
    <div className="flex items-center justify-between mb-4"><h2 className="text-xl font-bold">ğŸ“‹ Batch Log</h2><button onClick={()=>setShowFilters(!showFilters)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold ${showFilters?'bg-accent text-white':'bg-gray-100 text-gray-600'}`}>âš™ Filters</button></div>
    <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search notes..." className="w-full px-4 py-2.5 bg-white rounded-xl border border-gray-200 text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-accent/30"/>
    {showFilters&&(<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 fade-in space-y-3">
      <div><label className="text-xs font-semibold text-gray-500">Category</label><div className="flex gap-2 flex-wrap mt-1">{['all',...CATEGORIES].map(c=>(<button key={c} onClick={()=>setFilterCat(c)} className={`px-3 py-1 rounded-full text-xs font-semibold ${filterCat===c?'text-white':'bg-gray-100 text-gray-600'}`} style={filterCat===c?{background:c==='all'?'#FF5722':CAT_COLORS[c]}:{}}>{c==='all'?'All':`${CAT_EMOJI[c]} ${c}`}</button>))}</div></div>
      <div><label className="text-xs font-semibold text-gray-500">Recipe</label><select value={filterRecipe} onChange={e=>setFilterRecipe(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm bg-white mt-1"><option value="">All recipes</option>{recipes.map(r=><option key={r.id} value={r.id}>{r.name}</option>)}</select></div>
      <div className="flex gap-3">
        <div className="flex-1"><label className="text-xs font-semibold text-gray-500">Min rating</label><select value={minRating} onChange={e=>setMinRating(+e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm bg-white mt-1"><option value={0}>Any</option>{[1,2,3,4,5].map(i=><option key={i} value={i}>{i}+</option>)}</select></div>
        <div className="flex-1"><label className="text-xs font-semibold text-gray-500">Cafe worthy</label><select value={filterCafe} onChange={e=>setFilterCafe(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm bg-white mt-1"><option value="all">All</option><option value="yes">Yes</option><option value="no">No</option></select></div>
      </div>
      <div><label className="text-xs font-semibold text-gray-500">Texture agent</label><select value={filterAgent} onChange={e=>setFilterAgent(e.target.value)} className="w-full px-3 py-2 border rounded-xl text-sm bg-white mt-1"><option value="all">All agents</option>{TEXTURE_AGENTS.map(a=><option key={a.key} value={a.key}>{a.label}</option>)}</select></div>
    </div>)}
    {filtered.length===0?(<EmptyState emoji="ğŸ“‹" title="No batches yet" desc="Log your first batch after cooking" action="Log Batch" onAction={()=>setView('add')}/>):(<div className="grid gap-3">{filtered.map(b=><BatchCard key={b.id} batch={b} recipe={recipes.find(r=>r.id===b.recipeId)} onClick={()=>{setSelectedId(b.id);setView('detail')}}/>)}</div>)}
    <FAB onClick={()=>setView('add')} label="Log batch"/>
    <Modal open={!!shareText} onClose={()=>setShareText('')} title="Share Batch"><textarea value={shareText} onChange={e=>setShareText(e.target.value)} rows={12} className="w-full px-3 py-2 border rounded-xl text-sm font-mono mb-3"/><button onClick={()=>{navigator.clipboard?.writeText(shareText);setShareText('')}} className="w-full py-2 bg-accent text-white rounded-xl font-semibold">ğŸ“‹ Copy to Clipboard</button></Modal>
  </div>);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function HeatMap({batches}){
  const today=new Date();const weeks=20;const cells=[];
  const startDate=new Date(today);startDate.setDate(startDate.getDate()-(weeks*7-1));
  const batchDays={};batches.forEach(b=>{const d=new Date(b.date||b.createdAt).toDateString();batchDays[d]=(batchDays[d]||0)+1});
  for(let i=0;i<weeks*7;i++){const d=new Date(startDate);d.setDate(d.getDate()+i);const key=d.toDateString();const count=batchDays[key]||0;const future=d>today;cells.push({date:d,count,future})}
  const rows=[[],[],[],[],[],[],[]];cells.forEach((c,i)=>rows[i%7].push(c));
  const colors=['#EBEDF0','#F7C97E','#E5960B','#C47A00','#8B5700'];
  return(
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
      <div className="flex items-center justify-between mb-3"><h3 className="font-bold text-gray-900 text-sm">ğŸ”¥ Batch Activity</h3><span className="text-xs text-gray-400">{weeks} weeks</span></div>
      <div className="overflow-x-auto"><div className="inline-grid gap-0.5" style={{gridTemplateColumns:`repeat(${weeks},1fr)`,gridTemplateRows:'repeat(7,1fr)'}}>
        {rows.flat().map((c,i)=>(<div key={i} className="heat-cell" title={c.future?'':`${c.date.toLocaleDateString()} â€” ${c.count} batch${c.count!==1?'es':''}`} style={{background:c.future?'transparent':colors[Math.min(c.count,4)],opacity:c.future?0.2:1}}/>))}
      </div></div>
      <div className="flex items-center gap-1 mt-2 justify-end"><span className="text-[10px] text-gray-400 mr-1">Less</span>{colors.map((c,i)=>(<div key={i} className="heat-cell" style={{background:c}}/>))}<span className="text-[10px] text-gray-400 ml-1">More</span></div>
    </div>
  );
}

function StatsCards({batches,recipes}){
  const totalBatches=batches.length;
  const avgOverall=totalBatches?Math.round(batches.reduce((s,b)=>s+(b.ratings?.overall||0),0)/totalBatches*10)/10:0;
  const cafeCount=batches.filter(b=>b.cafeWorthy).length;
  const uniqueRecipes=new Set(batches.map(b=>b.recipeId)).size;
  const streak=(()=>{let s=0;const d=new Date();d.setHours(0,0,0,0);const bSet=new Set(batches.map(b=>new Date(b.date||b.createdAt).toDateString()));while(true){if(bSet.has(d.toDateString())){s++;d.setDate(d.getDate()-7)}else break}return s})();
  const stats=[
    {emoji:'ğŸ¦',label:'Total batches',value:totalBatches},
    {emoji:'â­',label:'Avg rating',value:avgOverall||'â€”'},
    {emoji:'â˜•',label:'Cafe worthy',value:cafeCount},
    {emoji:'ğŸ“–',label:'Recipes tried',value:uniqueRecipes},
    {emoji:'ğŸ”¥',label:'Week streak',value:streak},
  ];
  return(
    <div className="grid grid-cols-3 gap-2 mb-4">
      {stats.map(s=>(<div key={s.label} className="bg-white rounded-xl p-3 shadow-sm border border-gray-100 text-center"><div className="text-xl mb-1">{s.emoji}</div><div className="text-lg font-extrabold text-gray-900">{s.value}</div><div className="text-[10px] text-gray-500 font-medium">{s.label}</div></div>))}
    </div>
  );
}

function SkillProgression({batches,recipes}){
  const skills=[
    {key:'custard',label:'Custard Base',emoji:'ğŸ¥š',milestones:['First custard batch','5 custard batches','Custard â‰¥4â˜…','10 custard batches'],check:b=>{const cb=b.filter(x=>{const r=recipes.find(r=>r.id===x.recipeId);return r?.category==='traditional'||r?.category==='keto'});return[cb.length>=1,cb.length>=5,cb.some(x=>(x.ratings?.overall||0)>=4),cb.length>=10]}},
    {key:'flavor',label:'Flavor Design',emoji:'ğŸ¨',milestones:['First non-vanilla','3 unique flavors','A flavor â‰¥4â˜…','5 unique flavors'],check:b=>{const nb=b.filter(x=>{const r=recipes.find(r=>r.id===x.recipeId);return r&&!r.isBaseline});const uniqueFlavors=new Set(nb.map(x=>x.recipeId)).size;return[nb.length>=1,uniqueFlavors>=3,nb.some(x=>(x.ratings?.overall||0)>=4),uniqueFlavors>=5]}},
    {key:'texture',label:'Texture Control',emoji:'ğŸ§Š',milestones:['Used a texture agent','Tried 2 agents','Agent batch â‰¥4â˜…','Tried 3+ agents'],check:b=>{const ab=b.filter(x=>x.textureAgentUsed&&x.textureAgentUsed!=='none');const uniqueAgents=new Set(ab.map(x=>x.textureAgentUsed)).size;return[ab.length>=1,uniqueAgents>=2,ab.some(x=>(x.ratings?.overall||0)>=4),uniqueAgents>=3]}},
    {key:'keto',label:'Keto / Low Sugar',emoji:'ğŸ¥‘',milestones:['First keto batch','3 keto batches','Keto â‰¥4â˜…','5 keto batches'],check:b=>{const kb=b.filter(x=>{const r=recipes.find(r=>r.id===x.recipeId);return r?.category==='keto'});return[kb.length>=1,kb.length>=3,kb.some(x=>(x.ratings?.overall||0)>=4),kb.length>=5]}},
    {key:'consistency',label:'Consistency',emoji:'ğŸ“',milestones:['Log 3 batches','Log 10 batches','3 cafe-worthy','Avg rating â‰¥4'],check:b=>{const avgR=b.length?b.reduce((s,x)=>s+(x.ratings?.overall||0),0)/b.length:0;return[b.length>=3,b.length>=10,b.filter(x=>x.cafeWorthy).length>=3,avgR>=4]}},
    {key:'experiment',label:'Experimentation',emoji:'ğŸ§ª',milestones:['First experimental','3 experimental','Experimental â‰¥4â˜…','5 experimental'],check:b=>{const eb=b.filter(x=>{const r=recipes.find(r=>r.id===x.recipeId);return r?.category==='experimental'});return[eb.length>=1,eb.length>=3,eb.some(x=>(x.ratings?.overall||0)>=4),eb.length>=5]}},
  ];
  return(
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
      <h3 className="font-bold text-gray-900 text-sm mb-4">ğŸ† Skill Progression</h3>
      <div className="space-y-4">
        {skills.map(skill=>{
          const results=skill.check(batches);
          const completed=results.filter(Boolean).length;
          const pct=Math.round(completed/skill.milestones.length*100);
          return(
            <div key={skill.key}>
              <div className="flex items-center justify-between mb-1.5"><span className="text-sm font-semibold">{skill.emoji} {skill.label}</span><span className="text-xs text-gray-500 font-medium">{pct}%</span></div>
              <div className="h-2 bg-gray-100 rounded-full overflow-hidden mb-2"><div className="h-full rounded-full transition-all duration-500" style={{width:`${pct}%`,background:pct>=100?'#22C55E':pct>=50?'#F59E0B':'#FF5722'}}/></div>
              <div className="grid grid-cols-2 gap-1">
                {skill.milestones.map((m,i)=>(<div key={i} className={`text-[11px] flex items-center gap-1 ${results[i]?'text-green-600':'text-gray-400'}`}><span>{results[i]?'âœ…':'â—‹'}</span>{m}</div>))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function RatingDistribution({batches}){
  const dist=[0,0,0,0,0];batches.forEach(b=>{const r=b.ratings?.overall;if(r>=1&&r<=5)dist[r-1]++});
  const max=Math.max(...dist,1);
  return(
    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
      <h3 className="font-bold text-gray-900 text-sm mb-3">ğŸ“Š Rating Distribution</h3>
      <div className="space-y-2">
        {[5,4,3,2,1].map(r=>(<div key={r} className="flex items-center gap-2"><span className="text-sm w-6 text-right font-medium text-gray-500">{r}â˜…</span><div className="flex-1 h-5 bg-gray-100 rounded-full overflow-hidden"><div className="h-full rounded-full transition-all" style={{width:`${(dist[r-1]/max)*100}%`,background:r>=4?'#22C55E':r>=3?'#F59E0B':'#EF4444'}}/></div><span className="text-xs w-6 text-gray-500">{dist[r-1]}</span></div>))}
      </div>
    </div>
  );
}

function ProgressTab({batches,recipes}){
  return(
    <div className="pb-20">
      <h2 className="text-xl font-bold mb-4">ğŸ“ˆ Progress</h2>
      {batches.length===0?(<EmptyState emoji="ğŸ“ˆ" title="No data yet" desc="Complete some batches to see your progress"/>):(
        <>
          <HeatMap batches={batches}/>
          <StatsCards batches={batches} recipes={recipes}/>
          <RatingDistribution batches={batches}/>
          <SkillProgression batches={batches} recipes={recipes}/>
        </>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP & RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function BackupModal({open,onClose,recipes,batches,importRecipe}){
  const[importText,setImportText]=useState('');const[importError,setImportError]=useState('');const[importMode,setImportMode]=useState('recipe');
  const doExport=()=>{
    const data={version:2,exportedAt:new Date().toISOString(),recipes,batches,preferences:S.get('icl-prefs')};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`icecreamlab-backup-${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);
  };
  const doImport=()=>{
    try{
      const data=JSON.parse(importText);
      if(data.version&&data.recipes){
        // Full backup restore
        if(data.recipes)data.recipes.forEach(r=>importRecipe(r));
        if(data.batches){const existing=S.get('icl-batches')||[];S.set('icl-batches',[...existing,...data.batches])}
        if(data.preferences)S.set('icl-prefs',data.preferences);
        setImportText('');setImportError('');onClose();
        window.location.reload();
      }else if(data.name&&data.ingredients){
        // Single recipe import
        importRecipe(data);setImportText('');setImportError('');onClose();
      }else{setImportError('Unrecognized format')}
    }catch{setImportError('Invalid JSON')}
  };
  return(
    <Modal open={open} onClose={onClose} title="Backup & Restore" wide>
      <div className="space-y-4">
        <div>
          <h3 className="font-semibold text-sm mb-2">ğŸ“¤ Export Full Backup</h3>
          <p className="text-xs text-gray-500 mb-2">Downloads all recipes, batches, and preferences as a JSON file.</p>
          <button onClick={doExport} className="w-full py-2.5 bg-accent text-white rounded-xl font-semibold text-sm hover:opacity-90">Download Backup</button>
        </div>
        <hr className="border-gray-100"/>
        <div>
          <h3 className="font-semibold text-sm mb-2">ğŸ“¥ Import</h3>
          <p className="text-xs text-gray-500 mb-2">Paste a full backup JSON or a single recipe JSON.</p>
          <textarea value={importText} onChange={e=>{setImportText(e.target.value);setImportError('')}} rows={6} placeholder='Paste JSON here...' className="w-full px-3 py-2 border rounded-xl text-sm font-mono mb-2 focus:outline-none focus:ring-2 focus:ring-accent/30"/>
          {importError&&<p className="text-xs text-red-500 mb-2">{importError}</p>}
          <button onClick={doImport} disabled={!importText.trim()} className="w-full py-2.5 bg-gray-900 text-white rounded-xl font-semibold text-sm disabled:opacity-40">Import</button>
        </div>
      </div>
    </Modal>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTOM NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS_NAV=[
  {key:'recipes',label:'Recipes',emoji:'ğŸ“–'},
  {key:'cook',label:'Cook',emoji:'ğŸ”¥'},
  {key:'log',label:'Log',emoji:'ğŸ“‹'},
  {key:'progress',label:'Progress',emoji:'ğŸ“ˆ'},
];

function BottomNav({active,onChange,hidden}){
  if(hidden)return null;
  return(
    <nav className="fixed bottom-0 left-0 right-0 z-40 bg-white/95 backdrop-blur border-t border-gray-200" style={{paddingBottom:'env(safe-area-inset-bottom)'}}>
      <div className="flex justify-around max-w-lg mx-auto">
        {TABS_NAV.map(t=>(
          <button key={t.key} onClick={()=>onChange(t.key)} className={`flex flex-col items-center py-2 px-4 min-w-[64px] transition-colors ${active===t.key?'text-accent':'text-gray-400'}`}>
            <span className="text-xl mb-0.5">{t.emoji}</span>
            <span className="text-[10px] font-semibold">{t.label}</span>
          </button>
        ))}
      </div>
    </nav>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP SHELL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const{prefs,save:savePrefs,isSetup}=usePreferences();
  const{recipes,addRecipe,updateRecipe,deleteRecipe,duplicateRecipe,importRecipe}=useRecipes(prefs);
  const{batches,addBatch,updateBatch,deleteBatch}=useBatches();

  const[tab,setTab]=useState('recipes');
  const[isCooking,setIsCooking]=useState(false);
  const[showBackup,setShowBackup]=useState(false);
  const[navParams,setNavParams]=useState({});

  const nav=(target,params={})=>{
    if(target==='log-add'){setTab('log');setNavParams({screen:'add',...params})}
    else if(target==='cook-active'){setTab('cook');setNavParams({screen:'active',...params})}
    else{setTab(target);setNavParams(params)}
  };

  // First launch â€” show preferences setup
  if(!isSetup){
    return <PreferencesSetup onSave={(p)=>savePrefs(p)}/>;
  }

  return(
    <div className="max-w-lg mx-auto px-4 pt-4 pb-2" style={{paddingTop:'max(16px, env(safe-area-inset-top))'}}>
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div>
          <h1 className="text-lg font-extrabold text-gray-900">ğŸ¦ Ice Cream Lab</h1>
          <p className="text-[11px] text-gray-400 font-medium -mt-0.5">ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ãƒ©ãƒœ</p>
        </div>
        <button onClick={()=>setShowBackup(true)} className="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 text-lg" title="Backup & Restore">ğŸ’¾</button>
      </div>

      {/* Tab content */}
      {tab==='recipes'&&<RecipesTab recipes={recipes} batches={batches} addRecipe={addRecipe} updateRecipe={updateRecipe} deleteRecipe={deleteRecipe} duplicateRecipe={duplicateRecipe} importRecipe={importRecipe} nav={nav} prefs={prefs} onPrefsChange={savePrefs}/>}
      {tab==='cook'&&<CookTab recipes={recipes} batches={batches} nav={nav} onCookingChange={setIsCooking} prefs={prefs} onPrefsChange={savePrefs}/>}
      {tab==='log'&&<LogTab recipes={recipes} batches={batches} addBatch={addBatch} updateBatch={updateBatch} deleteBatch={deleteBatch} nav={nav} initialView={navParams.screen} initialFilter={navParams.filter} initialRecipeId={navParams.recipeId} prefs={prefs} initialCookNotes={navParams.cookNotes} initialYolkWeightG={navParams.yolkWeightG} initialScaledFromBatchMl={navParams.scaledFromBatchMl}/>}
      {tab==='progress'&&<ProgressTab batches={batches} recipes={recipes}/>}

      {/* Bottom nav â€” hidden when cooking */}
      <BottomNav active={tab} onChange={t=>{setTab(t);setNavParams({})}} hidden={isCooking}/>

      {/* Backup modal */}
      <BackupModal open={showBackup} onClose={()=>setShowBackup(false)} recipes={recipes} batches={batches} importRecipe={importRecipe}/>
    </div>
  );
}

// Mount
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>

<!-- Service Worker Registration -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
